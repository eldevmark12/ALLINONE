{% extends "base.html" %}

{% block title %}SMTP Management - ALL-in-One Email Portal{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="pageLoadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column;">
    <div class="spinner-border text-white" role="status" style="width: 4rem; height: 4rem; border-width: 0.4rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
    <h3 class="text-white mt-4">Loading SMTP Servers...</h3>
    <p class="text-white-50">Please wait</p>
</div>

<div class="row">
    <div class="col-12 mb-4">
        <h1><i class="bi bi-server"></i> SMTP Management</h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card bg-primary text-white">
            <div class="card-body">
                <h6 class="text-uppercase">Total SMTPs</h6>
                <h2 id="totalCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-success text-white">
            <div class="card-body">
                <h6 class="text-uppercase">Active</h6>
                <h2 id="activeCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-warning text-white">
            <div class="card-body">
                <h6 class="text-uppercase">Inactive</h6>
                <h2 id="inactiveCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-info text-white">
            <div class="card-body">
                <h6 class="text-uppercase">Validating</h6>
                <h2 id="validatingCount">0</h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">SMTP Servers</h5>
                <div>
                    <button class="btn btn-success btn-sm me-2" onclick="showBulkAddModal()">
                        <i class="bi bi-plus-square"></i> Bulk Add SMTPs
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="addServer()">
                        <i class="bi bi-plus-circle"></i> Add Server
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="alertContainer"></div>
                
                <!-- Action Buttons -->
                <div class="mb-3 d-flex gap-2 flex-wrap">
                    <button class="btn btn-info btn-sm" onclick="validateSelected()">
                        <i class="bi bi-check-circle"></i> Validate Selected
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="validateAll()">
                        <i class="bi bi-check2-all"></i> Validate All
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="selectAll()">
                        <i class="bi bi-check-square"></i> Select All
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="deselectAll()">
                        <i class="bi bi-square"></i> Deselect All
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteSelected()">
                        <i class="bi bi-trash"></i> Delete Selected
                    </button>
                </div>
                
                <!-- Filter Tabs -->
                <ul class="nav nav-tabs mb-3" id="smtpTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-filter="all" onclick="filterServers('all')">All</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-filter="active" onclick="filterServers('active')">Active</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-filter="inactive" onclick="filterServers('inactive')">Inactive</a>
                    </li>
                </ul>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="30"><input type="checkbox" id="selectAllCheck" onchange="toggleSelectAll()"></th>
                                <th>Status</th>
                                <th>Email</th>
                                <th>Password</th>
                                <th>Host</th>
                                <th>Port</th>
                                <th>Sent</th>
                                <th width="150">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="smtpTableBody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button class="btn btn-success mt-3" onclick="saveServers()">
                    <i class="bi bi-save"></i> Save All Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Validation Progress Modal -->
<div class="modal fade" id="validationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-gear-fill"></i> SMTP Validation in Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>Progress: <span id="validationProgress">0/0</span></h6>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="validationProgressBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h3 id="validatedCount">0</h3>
                                <small>Validated</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <h3 id="failedCount">0</h3>
                                <small>Failed</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h3 id="pendingCount">0</h3>
                                <small>Pending</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="log-container" id="validationLogs" style="max-height: 400px; overflow-y: auto; background-color: #1a1a1a; color: #00ff00; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 13px;">
                    <div style="color: #00ff00;">Validation will start shortly...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Add Modal -->
<div class="modal fade" id="bulkAddModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-square"></i> Bulk Add SMTP Servers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Paste SMTP servers in format: <code>email:password:server:port</code> (one per line)</p>
                <textarea class="form-control" id="bulkSmtpInput" rows="15" placeholder="hj4321@citiz.net:Jh13245*:smtp.citiz.net:587
danish.ismail@isianpadu.com:B89e9pmX!GxQMnBo:mail.isianpadu.com:587"></textarea>
                <div class="mt-2">
                    <small class="text-info"><i class="bi bi-info-circle"></i> Duplicates will be automatically removed</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="processBulkAdd()">
                    <i class="bi bi-check"></i> Add Servers
                </button>
            </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let socket;
let servers = [];
let currentFilter = 'all';
let isValidating = false; // Track validation state
let socketInitAttempts = 0;
const MAX_SOCKET_INIT_ATTEMPTS = 5;
let pollingInterval = null; // For fallback polling when Socket.IO fails
let socketConnected = false; // Track Socket.IO connection status

// Initialize Socket.IO when available (with crash prevention)
function initSocket() {
    socketInitAttempts++;
    
    if (socketInitAttempts > MAX_SOCKET_INIT_ATTEMPTS) {
        console.warn('‚ùå Max Socket.IO init attempts reached - using polling fallback only');
        socketConnected = false;
        return;
    }
    
    // Use global socket from base.html (always available)
    if (window.socket) {
        console.log('‚úÖ Using global Socket.IO connection from base.html');
        socket = window.socket;
        socketConnected = window.socket.connected;
        
        // Register event handlers
        socket.on('connect', function() {
            console.log('‚úÖ SMTP Socket.IO connected');
            socketConnected = true;
            stopPollingFallback();
        });
        
        socket.on('disconnect', function() {
            console.warn('‚ö†Ô∏è Socket.IO disconnected');
            socketConnected = false;
            if (isValidating) {
                console.log('üîÑ Socket.IO disconnected during validation - starting polling fallback');
                startPollingFallback();
            }
        });
        
        socket.on('connect_error', function(error) {
            console.warn('‚ö†Ô∏è SMTP Socket connection error:', error.message);
            socketConnected = false;
            if (isValidating) {
                console.log('üîÑ Socket.IO failed during validation - starting polling fallback');
                startPollingFallback();
            }
        });
        }
        
        // Register event handlers
        socket.on('validation_log', function(data) {
            addValidationLog(data.message);
        });

        socket.on('validation_stats', function(stats) {
            updateValidationStats(stats);
        });

        socket.on('validation_complete', function(data) {
            addValidationLog('‚úÖ Validation completed!');
            isValidating = false; // Reset validation state
            document.getElementById('validatingCount').textContent = '0';
            setTimeout(() => {
                loadServers();
            }, 2000);
        });
    } else {
        // No socket available, rely on polling fallback
        console.warn('‚ö†Ô∏è window.socket not available - will use polling fallback only');
        socketConnected = false;
    }
}

initSocket();

// Polling fallback when Socket.IO fails
function startPollingFallback() {
    if (pollingInterval) return; // Already polling
    
    console.log('üîÑ Starting polling fallback (checking every 2 seconds)');
    pollingInterval = setInterval(() => {
        if (!isValidating) {
            stopPollingFallback();
            return;
        }
        
        // Poll validation status
        fetch('/api/smtp/list')
            .then(res => res.json())
            .then(data => {
                if (data.success && data.servers) {
                    // Calculate stats from server list
                    const active = data.servers.filter(s => s.status === 'active').length;
                    const inactive = data.servers.filter(s => s.status === 'inactive').length;
                    const total = data.servers.length;
                    const validated = active + inactive;
                    const pending = total - validated;
                    
                    // Update UI with polled data
                    updateValidationStats({
                        validated: validated,
                        failed: inactive,
                        pending: pending,
                        total: total
                    });
                    
                    // Check if validation complete
                    if (validated >= total && isValidating) {
                        console.log('‚úÖ Polling detected validation complete');
                        addValidationLog('‚úÖ Validation completed!');
                        isValidating = false;
                        document.getElementById('validatingCount').textContent = '0';
                        stopPollingFallback();
                        setTimeout(() => loadServers(), 1000);
                    }
                }
            })
            .catch(err => {
                console.warn('‚ö†Ô∏è Polling error:', err.message);
            });
    }, 2000); // Poll every 2 seconds
}

function stopPollingFallback() {
    if (pollingInterval) {
        console.log('üõë Stopping polling fallback');
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
}

function loadServers() {
    fetch('/api/smtp/list')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                servers = data.servers;
                renderTable();
                updateCounts();
                
                // Hide loading overlay after first successful load
                const overlay = document.getElementById('pageLoadingOverlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    overlay.style.transition = 'opacity 0.3s ease-out';
                    setTimeout(() => overlay.remove(), 300);
                }
            }
        })
        .catch(err => {
            showAlert('Error loading SMTP servers: ' + err.message, 'danger');
            
            // Hide overlay even on error to show the error message
            const overlay = document.getElementById('pageLoadingOverlay');
            if (overlay) {
                overlay.style.opacity = '0';
                overlay.style.transition = 'opacity 0.3s ease-out';
                setTimeout(() => overlay.remove(), 300);
            }
        });
}

function renderTable() {
    const tbody = document.getElementById('smtpTableBody');
    let filteredServers = [];
    let filteredIndices = [];
    
    if (currentFilter === 'active') {
        servers.forEach((s, idx) => {
            if (s.status === 'active') {
                filteredServers.push(s);
                filteredIndices.push(idx);
            }
        });
    } else if (currentFilter === 'inactive') {
        servers.forEach((s, idx) => {
            if (s.status === 'inactive' || !s.status) {
                filteredServers.push(s);
                filteredIndices.push(idx);
            }
        });
    } else {
        filteredServers = servers;
        filteredIndices = servers.map((s, idx) => idx);
    }
    
    if (filteredServers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No SMTP servers configured. Click "Add Server" or "Bulk Add SMTPs" to get started.</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredServers.map((server, index) => {
        const actualIndex = filteredIndices[index];
        const statusBadge = server.status === 'active' 
            ? '<span class="badge bg-success">Active</span>' 
            : '<span class="badge bg-secondary">Inactive</span>';
        const sentCount = server.sent || 0;
        
        return `
        <tr>
            <td><input type="checkbox" class="server-check" data-index="${actualIndex}"></td>
            <td>${statusBadge}</td>
            <td><input type="text" class="form-control form-control-sm" value="${server.username || server.email || ''}" onchange="updateServer(${actualIndex}, 'username', this.value)"></td>
            <td><input type="password" class="form-control form-control-sm" value="${server.password}" onchange="updateServer(${actualIndex}, 'password', this.value)"></td>
            <td><input type="text" class="form-control form-control-sm" value="${server.host}" onchange="updateServer(${actualIndex}, 'host', this.value)"></td>
            <td><input type="number" class="form-control form-control-sm" value="${server.port}" onchange="updateServer(${actualIndex}, 'port', this.value)"></td>
            <td><span class="badge bg-info">${sentCount}</span></td>
            <td>
                <button class="btn btn-info btn-sm" onclick="validateSingle(${actualIndex})" title="Validate">
                    <i class="bi bi-check-circle"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteServer(${actualIndex})" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `}).join('');
}

function updateCounts() {
    try {
        const total = servers.length;
        const active = servers.filter(s => s.status === 'active').length;
        const inactive = servers.filter(s => s.status === 'inactive' || !s.status).length;
        
        document.getElementById('totalCount').textContent = total;
        document.getElementById('activeCount').textContent = active;
        document.getElementById('inactiveCount').textContent = inactive;
    } catch (error) {
        console.error('Error updating SMTP counts:', error);
        console.error('Servers data:', servers);
    }
}

function filterServers(filter) {
    currentFilter = filter;
    document.querySelectorAll('#smtpTabs .nav-link').forEach(link => {
        link.classList.remove('active');
    });
    document.querySelector(`#smtpTabs .nav-link[data-filter="${filter}"]`).classList.add('active');
    renderTable();
}

function addServer() {
    servers.push({
        host: 'smtp.example.com',
        port: '587',
        username: 'user@example.com',
        password: '',
        status: 'inactive'
    });
    renderTable();
    updateCounts();
}

function updateServer(index, field, value) {
    if (field === 'username') {
        servers[index].username = value;
        servers[index].email = value;
    } else {
        servers[index][field] = value;
    }
}

function deleteServer(index) {
    if (confirm('Are you sure you want to delete this SMTP server?')) {
        console.log(`üóëÔ∏è Deleting server at index ${index}:`, servers[index]);
        servers.splice(index, 1);
        renderTable();
        updateCounts();
        // Save immediately to persist deletion
        saveServers();
    }
}

function showBulkAddModal() {
    const modal = new bootstrap.Modal(document.getElementById('bulkAddModal'));
    modal.show();
}

function processBulkAdd() {
    const input = document.getElementById('bulkSmtpInput').value;
    const lines = input.split('\n').filter(line => line.trim());
    
    const newServers = [];
    const existing = new Set(servers.map(s => `${s.username}:${s.host}:${s.port}`));
    
    lines.forEach(line => {
        const parts = line.trim().split(':');
        if (parts.length >= 4) {
            const email = parts[0].trim();
            const password = parts[1].trim();
            const host = parts[2].trim();
            const port = parts[3].trim();
            
            const key = `${email}:${host}:${port}`;
            if (!existing.has(key)) {
                newServers.push({
                    username: email,
                    email: email,
                    password: password,
                    host: host,
                    port: port,
                    status: 'inactive'
                });
                existing.add(key);
            }
        }
    });
    
    servers.push(...newServers);
    renderTable();
    updateCounts();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('bulkAddModal'));
    modal.hide();
    document.getElementById('bulkSmtpInput').value = '';
    
    showAlert(`Added ${newServers.length} new SMTP servers (duplicates removed)`, 'success');
}

function selectAll() {
    document.querySelectorAll('.server-check').forEach(cb => cb.checked = true);
}

function deselectAll() {
    document.querySelectorAll('.server-check').forEach(cb => cb.checked = false);
}

function toggleSelectAll() {
    const checked = document.getElementById('selectAllCheck').checked;
    document.querySelectorAll('.server-check').forEach(cb => cb.checked = checked);
}

function getSelectedIndices() {
    const indices = [];
    document.querySelectorAll('.server-check:checked').forEach(cb => {
        indices.push(parseInt(cb.dataset.index));
    });
    return indices;
}

function deleteSelected() {
    const indices = getSelectedIndices();
    if (indices.length === 0) {
        showAlert('Please select servers to delete', 'warning');
        return;
    }
    
    // Get the servers that will be deleted for confirmation
    const serversToDelete = indices.map(i => servers[i]);
    const deleteInfo = serversToDelete.map(s => `${s.username || s.email} (${s.status})`).join(', ');
    
    if (confirm(`Delete ${indices.length} selected server(s)?\n\n${deleteInfo.substring(0, 200)}${deleteInfo.length > 200 ? '...' : ''}`)) {
        console.log(`üóëÔ∏è Deleting ${indices.length} servers at indices:`, indices);
        console.log('Servers to delete:', serversToDelete);
        
        // Create a new array WITHOUT the selected indices (more reliable than splice)
        const indicesToDelete = new Set(indices);
        const newServers = servers.filter((server, index) => !indicesToDelete.has(index));
        
        console.log(`Before delete: ${servers.length} servers`);
        console.log(`After delete: ${newServers.length} servers`);
        console.log(`Deleted: ${servers.length - newServers.length} servers`);
        
        // Replace the servers array
        servers = newServers;
        
        renderTable();
        updateCounts();
        showAlert(`${indices.length} server(s) deleted`, 'success');
        // Save immediately to persist deletion
        saveServers();
    }
}

function validateSingle(index) {
    validateServers([index]);
}

function validateSelected() {
    const indices = getSelectedIndices();
    if (indices.length === 0) {
        showAlert('Please select servers to validate', 'warning');
        return;
    }
    validateServers(indices);
}

function validateAll() {
    const indices = servers.map((_, i) => i);
    validateServers(indices);
}

function validateServers(indices) {
    // Check if validation is already running
    if (isValidating) {
        showAlert('‚ö†Ô∏è Validation is already in progress! Please wait for it to complete.', 'warning');
        return;
    }
    
    const selectedServers = indices.map(i => servers[i]);
    
    console.log(`üîç Starting validation of ${selectedServers.length} SMTP servers:`, selectedServers.map(s => s.username || s.email));
    
    // Show validation modal
    const modal = new bootstrap.Modal(document.getElementById('validationModal'));
    modal.show();
    
    // Reset validation UI
    document.getElementById('validationLogs').innerHTML = `<div class="text-success"><strong>üìã Starting validation of ${selectedServers.length} SMTP servers...</strong></div>`;
    document.getElementById('validationProgress').textContent = `0/${selectedServers.length}`;
    document.getElementById('validationProgressBar').style.width = '0%';
    document.getElementById('validatedCount').textContent = '0';
    document.getElementById('failedCount').textContent = '0';
    document.getElementById('pendingCount').textContent = selectedServers.length;
    document.getElementById('validatingCount').textContent = selectedServers.length;
    
    // Set validation flag
    isValidating = true;
    
    // Start validation
    fetch('/api/smtp/validate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({servers: selectedServers})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            addValidationLog(`‚úì Validation started successfully for ${selectedServers.length} servers`);
            addValidationLog(`‚è≥ Testing SMTP connections and sending test emails...`);
            
            // If Socket.IO isn't connected, start polling fallback immediately
            if (!socketConnected) {
                console.log('‚ö†Ô∏è Socket.IO not connected - starting polling fallback');
                addValidationLog('‚ÑπÔ∏è Using polling fallback (Socket.IO unavailable)');
                setTimeout(() => startPollingFallback(), 1000); // Start after 1 second
            }
        } else {
            showAlert('Error: ' + data.error, 'danger');
            isValidating = false; // Reset on error
        }
    })
    .catch(err => {
        showAlert('Error starting validation: ' + err.message, 'danger');
        isValidating = false; // Reset on error
    });
}

function addValidationLog(message) {
    const logContainer = document.getElementById('validationLogs');
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    logEntry.style.color = '#00ff00';
    logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

function updateValidationStats(stats) {
    try {
        const total = stats.total || 0;
        const sent = stats.sent || 0;
        const failed = stats.failed || 0;
        const validated = stats.validated || 0;
        
        // Calculate pending as total minus validated (not sent+failed)
        const pending = Math.max(0, total - validated);
        
        // Progress shows validated/total (not completed/total)
        document.getElementById('validationProgress').textContent = `${validated}/${total}`;
        document.getElementById('validationProgressBar').style.width = total > 0 ? `${(validated/total)*100}%` : '0%';
        document.getElementById('validatedCount').textContent = validated;
        document.getElementById('failedCount').textContent = failed;
        document.getElementById('pendingCount').textContent = pending;
        
        // Update header count
        if (document.getElementById('validatingCount')) {
            document.getElementById('validatingCount').textContent = pending > 0 ? pending : 0;
        }
    } catch (error) {
        console.error('Error updating validation stats:', error);
        console.error('Stats received:', stats);
    }
}

function saveServers() {
    console.log('üíæ Saving SMTP servers:', servers);
    
    fetch('/api/smtp/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({servers: servers})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            console.log('‚úÖ Servers saved successfully');
            // Reload from backend to ensure sync
            setTimeout(() => {
                console.log('üîÑ Reloading servers from backend...');
                loadServers();
            }, 500);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(err => {
        console.error('‚ùå Error saving servers:', err);
        showAlert('Error saving: ' + err.message, 'danger');
    });
}

function showAlert(message, type) {
    const alertDiv = document.getElementById('alertContainer');
    alertDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
    setTimeout(() => alertDiv.innerHTML = '', 5000);
}

// Load on page load
loadServers();
</script>
{% endblock %}
