{% extends "base.html" %}

{% block title %}Campaign Settings - ALL-in-One Email Portal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h1><i class="bi bi-gear-fill"></i> Campaign Manager</h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-envelope-fill"></i> From Emails</h5>
                <h2 class="mb-0" id="fromCount">
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                </h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-people-fill"></i> Recipients</h5>
                <h2 class="mb-0" id="recipientCount">
                    <span class="spinner-border spinner-border-sm" role="status"></span>
                </h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-send-fill"></i> Sent</h5>
                <h2 class="mb-0" id="sentCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-x-circle-fill"></i> Failed</h5>
                <h2 class="mb-0" id="failedCount">0</h2>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Tabs -->
<div class="row">
    <div class="col-12">
        <ul class="nav nav-tabs" id="campaignTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">
                    <i class="bi bi-gear"></i> Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="from-tab" data-bs-toggle="tab" data-bs-target="#from" type="button">
                    <i class="bi bi-envelope"></i> From Emails
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="recipients-tab" data-bs-toggle="tab" data-bs-target="#recipients" type="button">
                    <i class="bi bi-people"></i> Recipients
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="console-tab" data-bs-toggle="tab" data-bs-target="#console" type="button">
                    <i class="bi bi-terminal"></i> Console
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="campaignTabContent">
            <!-- Settings Tab -->
            <div class="tab-pane fade show active" id="settings" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div id="alertContainer"></div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><strong>Sender Name</strong></label>
                                <input type="text" class="form-control" id="sendername" value="Support">
                                <small class="text-muted">Display name for sender</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><strong>Subject</strong></label>
                                <input type="text" class="form-control" id="subject" value="Hello, how are you?">
                                <small class="text-muted">Email subject line</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label"><strong>Message (HTML Supported)</strong></label>
                                <textarea class="form-control font-monospace" id="message" rows="12" style="font-size: 13px;"></textarea>
                                <small class="text-muted">
                                    Email message body (supports HTML). 
                                    <strong>Random strings:</strong> Use <code>{{RANDOM5}}</code> for 5-char, <code>{{RANDOM10}}</code> for 10-char, or <code>{{RANDOM}}</code> for 8-char random strings.
                                </small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><strong>Domain From</strong></label>
                                <input type="text" class="form-control" id="domainfrom" placeholder="charter.net">
                                <small class="text-muted">Domain for sender email</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><strong>Domain Authentication</strong></label>
                                <input type="text" class="form-control" id="domainauth" placeholder="altona.fr">
                                <small class="text-muted">Authentication domain</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><strong>Sleep Time (seconds)</strong></label>
                                <input type="number" class="form-control" id="sleeptime" value="1" min="0" step="0.1">
                                <small class="text-muted">Delay between each email</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><strong>Threads</strong></label>
                                <input type="number" class="form-control" id="threads" value="10" min="1" max="100">
                                <small class="text-muted">Number of concurrent sending threads</small>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="saveConfig()">
                                <i class="bi bi-save"></i> Save Configuration
                            </button>
                            <button class="btn btn-secondary" onclick="loadConfig()">
                                <i class="bi bi-arrow-clockwise"></i> Reload
                            </button>
                            <button class="btn btn-info" onclick="loadDefaultTemplate()">
                                <i class="bi bi-file-earmark-text"></i> Load Sample HTML
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- From Emails Tab -->
            <div class="tab-pane fade" id="from" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0">From Email Addresses</h5>
                            <div>
                                <button class="btn btn-primary" onclick="showBulkFromModal()">
                                    <i class="bi bi-plus-circle"></i> Bulk Add
                                </button>
                                <button class="btn btn-danger" onclick="clearFromList()">
                                    <i class="bi bi-trash"></i> Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Note:</strong> For performance reasons, we don't display all from emails in the table. 
                            Use the statistics card above to see the total count.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h1 class="display-4 text-primary" id="fromCountLarge">0</h1>
                                        <p class="text-muted mb-0">Total From Emails</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="text-muted">Quick Actions</h6>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary" onclick="showBulkFromModal()">
                                                <i class="bi bi-file-earmark-arrow-up"></i> Upload/Paste From Emails
                                            </button>
                                            <button class="btn btn-outline-success" onclick="showFromFileUpload()">
                                                <i class="bi bi-cloud-upload"></i> Upload from.txt File
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="clearFromList()">
                                                <i class="bi bi-trash"></i> Delete All From Emails
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recipients Tab -->
            <div class="tab-pane fade" id="recipients" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0">Recipient Email Addresses</h5>
                            <div>
                                <button class="btn btn-primary" onclick="showBulkRecipientsModal()">
                                    <i class="bi bi-plus-circle"></i> Bulk Add
                                </button>
                                <button class="btn btn-danger" onclick="clearRecipientsList()">
                                    <i class="bi bi-trash"></i> Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Note:</strong> For performance reasons, we don't display all recipients in the table. 
                            Use the statistics card above to see the total count.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h1 class="display-4 text-info" id="recipientCountLarge">0</h1>
                                        <p class="text-muted mb-0">Total Recipients</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="text-muted">Quick Actions</h6>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary" onclick="showBulkRecipientsModal()">
                                                <i class="bi bi-file-earmark-arrow-up"></i> Upload/Paste Recipients
                                            </button>
                                            <button class="btn btn-outline-success" onclick="showRecipientsFileUpload()">
                                                <i class="bi bi-cloud-upload"></i> Upload emailx.txt File
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="clearRecipientsList()">
                                                <i class="bi bi-trash"></i> Delete All Recipients
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Console Tab -->
            <div class="tab-pane fade" id="console" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <h5>Campaign Console</h5>
                            <div>
                                <button class="btn btn-success" onclick="startCampaign()" id="startBtn">
                                    <i class="bi bi-play-fill"></i> Start Campaign
                                </button>
                                <button class="btn btn-danger" onclick="stopCampaign()" id="stopBtn" style="display:none;">
                                    <i class="bi bi-stop-fill"></i> Stop Campaign
                                </button>
                                <button class="btn btn-secondary" onclick="clearConsole()">
                                    <i class="bi bi-trash"></i> Clear
                                </button>
                            </div>
                        </div>
                        
                        <div id="consoleOutput" style="background-color: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; height: 600px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                            <div class="text-success">Console ready. Click "Start Campaign" to begin sending...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Add From Emails Modal -->
<div class="modal fade" id="bulkFromModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Add From Emails</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Paste email addresses (one per line). Duplicates will be removed automatically.</p>
                <textarea class="form-control" id="bulkFromInput" rows="15" placeholder="email1@example.com&#10;email2@example.com&#10;email3@example.com"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="processBulkFrom()">Add Emails</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Add Recipients Modal -->
<div class="modal fade" id="bulkRecipientsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Add Recipients</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Paste recipient email addresses (one per line). Duplicates will be removed automatically.</p>
                <textarea class="form-control" id="bulkRecipientsInput" rows="15" placeholder="recipient1@example.com&#10;recipient2@example.com&#10;recipient3@example.com"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="processBulkRecipients()">Add Emails</button>
            </div>
        </div>
    </div>
</div>

<!-- File Upload Modal for From Emails -->
<div class="modal fade" id="fromFileUploadModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-cloud-upload-fill"></i> Upload from.txt File
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" id="fileUploadCloseBtn"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill"></i>
                    <strong>Large File Support:</strong> This uploader can handle files up to 200+ MB with millions of emails.
                    <ul class="mb-0 mt-2">
                        <li>Files are processed in chunks for better performance</li>
                        <li>Duplicates are automatically removed</li>
                        <li>Progress is shown in real-time</li>
                    </ul>
                </div>
                
                <!-- File Input -->
                <div class="mb-4" id="fileSelectSection">
                    <label for="fromFileInput" class="form-label"><strong>Select from.txt file:</strong></label>
                    <input type="file" class="form-control form-control-lg" id="fromFileInput" accept=".txt" onchange="handleFromFileSelect(event)">
                    <small class="text-muted">Supported format: Plain text file with one email per line</small>
                </div>
                
                <!-- File Info -->
                <div class="card mb-3 d-none" id="fileInfoCard">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-file-earmark-text"></i> File Information</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">Filename:</small>
                                <div><strong id="fileName">-</strong></div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Size:</small>
                                <div><strong id="fileSize">-</strong></div>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Emails Found:</small>
                                <div><strong id="emailsFound" class="text-primary">-</strong></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Section -->
                <div class="d-none" id="uploadProgressSection">
                    <div class="card border-primary">
                        <div class="card-body">
                            <h6 class="card-title">
                                <span class="spinner-border spinner-border-sm me-2" id="uploadSpinner"></span>
                                <span id="uploadStatusText">Processing...</span>
                            </h6>
                            
                            <!-- Progress Bar -->
                            <div class="progress mb-3" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     id="uploadProgressBar" 
                                     role="progressbar" 
                                     style="width: 0%">
                                    <span id="uploadProgressText">0%</span>
                                </div>
                            </div>
                            
                            <!-- Stats -->
                            <div class="row text-center">
                                <div class="col-4">
                                    <small class="text-muted">Processed</small>
                                    <div><strong id="emailsProcessed" class="text-info">0</strong></div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Valid</small>
                                    <div><strong id="emailsValid" class="text-success">0</strong></div>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted">Duplicates</small>
                                    <div><strong id="emailsDuplicates" class="text-warning">0</strong></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Success Message -->
                <div class="alert alert-success d-none" id="uploadSuccessAlert">
                    <i class="bi bi-check-circle-fill"></i>
                    <strong>Upload Complete!</strong>
                    <div id="uploadSummary"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="fileUploadCancelBtn">Cancel</button>
                <button type="button" class="btn btn-success" onclick="startFileUpload()" id="fileUploadStartBtn" disabled>
                    <i class="bi bi-upload"></i> Start Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Page Loading Overlay -->
<div id="pageLoadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(52, 152, 219, 0.95) 0%, rgba(41, 128, 185, 0.95) 100%); z-index: 9999; display: flex; justify-content: center; align-items: center;">
    <div style="text-align: center; color: white;">
        <div class="spinner-border mb-3" style="width: 4rem; height: 4rem; border-width: 0.3rem;" role="status"></div>
        <h3>Loading Campaign Manager...</h3>
        <p class="mb-0">Fetching configuration and statistics</p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let campaignSocket = null;
let campaignRunning = false;
let campaignSocketInitAttempts = 0;
const MAX_CAMPAIGN_SOCKET_ATTEMPTS = 5;

// Initialize socket connection with crash prevention
function initCampaignSocket() {
    campaignSocketInitAttempts++;
    
    if (campaignSocketInitAttempts > MAX_CAMPAIGN_SOCKET_ATTEMPTS) {
        console.warn('‚ùå Max campaign socket init attempts reached - using polling fallback only');
        return;
    }
    
    // Use global socket from base.html (always available)
    if (window.socket) {
        console.log('‚úÖ Using global Socket.IO connection for campaign');
        campaignSocket = window.socket;
        
        // Remove existing listeners to prevent duplicates
        campaignSocket.off('campaign_log');
        campaignSocket.off('campaign_stats');
        campaignSocket.off('from_count_update');
        campaignSocket.off('campaign_complete');
        
        console.log('üîå Campaign Socket.IO event handlers registered');
        
        campaignSocket.on('campaign_log', function(data) {
            console.log(`üìù Campaign Log [${data.type}]:`, data.message);
            addConsoleLog(data.message, data.type || 'info');
        });
        
        campaignSocket.on('campaign_stats', function(data) {
            console.log('üìä Campaign Stats:', data);
            updateStats(data);
        });
        
        campaignSocket.on('from_count_update', function(data) {
            // Update from email count in real-time as emails are used
            console.log(`üìß From count updated: ${data.remaining} remaining`);
            document.getElementById('fromCount').textContent = data.remaining;
            document.getElementById('fromCountLarge').textContent = data.remaining.toLocaleString();
        });
        
        campaignSocket.on('campaign_complete', function(data) {
            console.log('‚úÖ Campaign completed:', data);
            campaignRunning = false;
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            addConsoleLog(`Campaign completed! Sent: ${data.sent}, Failed: ${data.failed}`, 'success');
            
            // No need to reload - Socket.IO already updated counts in real-time
        });
    } else {
        console.warn('‚ö†Ô∏è window.socket not available - real-time campaign updates disabled');
    }
    }
}

// Load configuration
function loadConfig() {
    console.log('‚öôÔ∏è Loading configuration...');
    
    // Show loading state in form
    const loadingMsg = document.getElementById('alertContainer');
    if (loadingMsg) {
        loadingMsg.innerHTML = `<div class="alert alert-info"><span class="spinner-border spinner-border-sm me-2"></span>Loading configuration...</div>`;
    }
    
    fetch('/api/config/get')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const config = data.config;
                console.log('‚úÖ Configuration loaded:', config);
                
                // Load with uppercase/lowercase fallbacks
                document.getElementById('sendername').value = config.SENDERNAME || config.sendername || 'Support';
                
                // Load subject - use default if subject is "hello" or empty
                let subjectValue = config.subject || config.SUBJECT || '';
                if (!subjectValue || subjectValue.trim() === '' || subjectValue.trim().toLowerCase() === 'hello') {
                    subjectValue = 'Important Security Alert - Action Required';
                    console.log('üìß Using default subject (was empty or "hello")');
                }
                document.getElementById('subject').value = subjectValue;
                
                // Load message - use default template if message is "hello" or empty
                let messageValue = config.MESSAGE || config.message || '';
                if (!messageValue || messageValue.trim() === '' || messageValue.trim().toLowerCase() === 'hello') {
                    messageValue = getDefaultTemplate();
                    console.log('üìÑ Using default HTML template (message was empty or "hello")');
                }
                document.getElementById('message').value = messageValue;
                
                document.getElementById('domainfrom').value = config.domainfrom || '';
                document.getElementById('domainauth').value = config.DOMAIN_AUTHENTICATION || config.domain_authentication || '';
                document.getElementById('sleeptime').value = config.SLEEPTIME || config.sleeptime || '1';
                document.getElementById('threads').value = config.threads || '10';
                
                // Clear loading message
                const loadingMsg = document.getElementById('alertContainer');
                if (loadingMsg) loadingMsg.innerHTML = '';
                
                console.log('üìù Form populated with configuration');
            } else {
                console.error('‚ùå Failed to load config:', data);
                showAlert('Error loading configuration', 'danger');
            }
        })
        .catch(err => {
            console.error('‚ùå Error loading configuration:', err);
            showAlert('Error loading configuration: ' + err.message, 'danger');
        });
}

// Save configuration
function saveConfig() {
    const settings = {
        SENDERNAME: document.getElementById('sendername').value || 'Support',
        subject: document.getElementById('subject').value || 'Hello, how are you?',
        MESSAGE: document.getElementById('message').value || getDefaultTemplate(),
        domainfrom: document.getElementById('domainfrom').value,
        DOMAIN_AUTHENTICATION: document.getElementById('domainauth').value,
        SLEEPTIME: document.getElementById('sleeptime').value || '1',
        threads: document.getElementById('threads').value || '10'
    };
    
    console.log('üíæ Saving configuration:', settings);
    
    fetch('/api/config/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(settings)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Configuration saved successfully');
            showAlert('Configuration saved successfully! Changes will be applied.', 'success');
            // Reload config to show saved values
            setTimeout(() => loadConfig(), 500);
        } else {
            console.error('‚ùå Failed to save config:', data);
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(err => {
        console.error('‚ùå Error saving configuration:', err);
        showAlert('Error saving configuration: ' + err.message, 'danger');
    });
}

// Load default HTML template
function loadDefaultTemplate() {
    console.log('üìÑ Loading default HTML template...');
    document.getElementById('message').value = getDefaultTemplate();
    showAlert('Sample HTML template loaded! Remember to save configuration.', 'info');
}

// Get default HTML email template
function getDefaultTemplate() {
    return `<html>
<body style="font-family: Arial, sans-serif; padding: 20px;">
    <p>Hi there,</p>
    
    <p>I hope this message finds you well. I wanted to reach out and say hello!</p>
    
    <p>I've been thinking about connecting with you and thought this would be a great opportunity.</p>
    
    <p>Looking forward to hearing from you soon.</p>
    
    <p>Best regards,<br>
    {{SENDERNAME}}</p>
</body>
</html>`;
}

// Load from emails
// Load from emails count
let fromEmailsCache = null;
let fromEmailsCacheTime = 0;
const CACHE_DURATION = 5000; // 5 seconds

function loadFromEmails(forceRefresh = false) {
    console.log('üìß Loading from emails count...', forceRefresh ? '(forced refresh)' : '');
    
    // Use cache if available and fresh (unless force refresh)
    const now = Date.now();
    if (!forceRefresh && fromEmailsCache !== null && (now - fromEmailsCacheTime < CACHE_DURATION)) {
        console.log('‚úÖ Using cached from emails count:', fromEmailsCache);
        document.getElementById('fromCount').textContent = fromEmailsCache;
        const largeCt = document.getElementById('fromCountLarge');
        if (largeCt) largeCt.textContent = fromEmailsCache.toLocaleString();
        return;
    }
    
    // Show loading spinner
    document.getElementById('fromCount').innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
    
    // Add cache-busting parameter to force fresh data
    const cacheBuster = `?t=${Date.now()}`;
    fetch(`/api/campaign/from/list${cacheBuster}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                console.log(`‚úÖ From emails loaded: ${data.count}`);
                fromEmailsCache = data.count;
                fromEmailsCacheTime = Date.now();
                document.getElementById('fromCount').textContent = data.count;
                const largeCt = document.getElementById('fromCountLarge');
                if (largeCt) largeCt.textContent = data.count.toLocaleString();
            } else {
                console.error('‚ùå Failed to load from emails:', data);
                document.getElementById('fromCount').textContent = '0';
            }
        })
        .catch(err => console.error('‚ùå Error loading from emails:', err));
}

// Load recipients
let recipientsCache = null;
let recipientsCacheTime = 0;

function loadRecipients(forceRefresh = false) {
    console.log('üë• Loading recipients count...', forceRefresh ? '(forced refresh)' : '');
    
    // Use cache if available and fresh (unless force refresh)
    const now = Date.now();
    if (!forceRefresh && recipientsCache !== null && (now - recipientsCacheTime < CACHE_DURATION)) {
        console.log('‚úÖ Using cached recipients count:', recipientsCache);
        document.getElementById('recipientCount').textContent = recipientsCache;
        const largeCt = document.getElementById('recipientCountLarge');
        if (largeCt) largeCt.textContent = recipientsCache.toLocaleString();
        return;
    }
    
    // Show loading spinner
    document.getElementById('recipientCount').innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
    
    fetch('/api/campaign/recipients/list')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                console.log(`‚úÖ Recipients loaded: ${data.count}`);
                recipientsCache = data.count;
                recipientsCacheTime = Date.now();
                document.getElementById('recipientCount').textContent = data.count;
                const largeCt = document.getElementById('recipientCountLarge');
                if (largeCt) largeCt.textContent = data.count.toLocaleString();
            } else {
                console.error('‚ùå Failed to load recipients:', data);
                document.getElementById('recipientCount').textContent = '0';
            }
        })
        .catch(err => console.error('‚ùå Error loading recipients:', err));
}

// Show bulk from modal
function showBulkFromModal() {
    const modal = new bootstrap.Modal(document.getElementById('bulkFromModal'));
    modal.show();
}

// Process bulk from emails
function processBulkFrom() {
    const input = document.getElementById('bulkFromInput').value;
    const emails = input.split('\n')
        .map(e => e.trim())
        .filter(e => e && e.includes('@'));
    
    console.log(`üìß Processing ${emails.length} from emails...`);
    
    if (emails.length === 0) {
        alert('No valid email addresses found');
        return;
    }
    
    fetch('/api/campaign/from/bulk', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({emails: emails})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            console.log(`‚úÖ Added ${data.added} from emails. Total: ${data.total}, Duplicates: ${data.duplicates}`);
            bootstrap.Modal.getInstance(document.getElementById('bulkFromModal')).hide();
            document.getElementById('bulkFromInput').value = '';
            loadFromEmails(); // Refresh count
            showAlert(`Successfully added ${data.added} new emails. Total: ${data.total.toLocaleString()} (${data.duplicates} duplicates removed)`, 'success');
        } else {
            console.error('‚ùå Failed to add from emails:', data);
            showAlert(data.message || 'Failed to add emails', 'danger');
        }
    })
    .catch(err => {
        console.error('‚ùå Error adding from emails:', err);
        showAlert('Network error while adding emails', 'danger');
    });
}

// Show bulk recipients modal
function showBulkRecipientsModal() {
    const modal = new bootstrap.Modal(document.getElementById('bulkRecipientsModal'));
    modal.show();
}

// Process bulk recipients
function processBulkRecipients() {
    const input = document.getElementById('bulkRecipientsInput').value;
    const emails = input.split('\n')
        .map(e => e.trim())
        .filter(e => e && e.includes('@'));
    
    console.log(`üë• Processing ${emails.length} recipient emails...`);
    
    if (emails.length === 0) {
        alert('No valid email addresses found');
        return;
    }
    
    fetch('/api/campaign/recipients/bulk', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({emails: emails})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            console.log(`‚úÖ Added ${data.added} recipients. Total: ${data.total}, Duplicates: ${data.duplicates}`);
            bootstrap.Modal.getInstance(document.getElementById('bulkRecipientsModal')).hide();
            document.getElementById('bulkRecipientsInput').value = '';
            loadRecipients(); // Refresh count
            showAlert(`Successfully added ${data.added} new emails. Total: ${data.total.toLocaleString()} (${data.duplicates} duplicates removed)`, 'success');
        } else {
            console.error('‚ùå Failed to add recipients:', data);
            showAlert(data.message || 'Failed to add emails', 'danger');
        }
    })
    .catch(err => {
        console.error('‚ùå Error adding recipients:', err);
        showAlert('Network error while adding emails', 'danger');
    });
}

// Clear from list
function clearFromList() {
    if (confirm('Are you sure you want to delete ALL from emails? This action cannot be undone!')) {
        console.log('üóëÔ∏è Clearing all from emails...');
        
        // Show loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'deleteLoadingOverlay';
        loadingDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; justify-content: center; align-items: center;';
        loadingDiv.innerHTML = `
            <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
                <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                <h4 class="text-danger">Deleting All From Emails...</h4>
                <p class="text-muted mb-0">Please wait...</p>
            </div>
        `;
        document.body.appendChild(loadingDiv);
        
        fetch('/api/campaign/from/clear', {method: 'POST'})
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ All from emails deleted');
                    // Show success message briefly then reload
                    loadingDiv.innerHTML = `
                        <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                            <h4 class="text-success mt-3">All From Emails Deleted!</h4>
                            <p class="text-muted mb-0">Refreshing page...</p>
                        </div>
                    `;
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    document.body.removeChild(loadingDiv);
                    console.error('‚ùå Failed to clear from emails:', data);
                    showAlert(data.message || 'Failed to clear emails', 'danger');
                }
            })
            .catch(err => {
                document.body.removeChild(loadingDiv);
                console.error('‚ùå Error clearing from emails:', err);
                showAlert('Network error while clearing emails', 'danger');
            });
    }
}

// Clear recipients list
function clearRecipientsList() {
    if (confirm('Are you sure you want to delete ALL recipients? This action cannot be undone!')) {
        console.log('üóëÔ∏è Clearing all recipients...');
        
        // Show loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'deleteLoadingOverlay';
        loadingDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; justify-content: center; align-items: center;';
        loadingDiv.innerHTML = `
            <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
                <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
                <h4 class="text-danger">Deleting All Recipients...</h4>
                <p class="text-muted mb-0">Please wait...</p>
            </div>
        `;
        document.body.appendChild(loadingDiv);
        
        fetch('/api/campaign/recipients/clear', {method: 'POST'})
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ All recipients deleted');
                    // Show success message briefly then reload
                    loadingDiv.innerHTML = `
                        <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                            <h4 class="text-success mt-3">All Recipients Deleted!</h4>
                            <p class="text-muted mb-0">Refreshing page...</p>
                        </div>
                    `;
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    document.body.removeChild(loadingDiv);
                    console.error('‚ùå Failed to clear recipients:', data);
                    showAlert(data.message || 'Failed to clear recipients', 'danger');
                }
            })
            .catch(err => {
                document.body.removeChild(loadingDiv);
                console.error('‚ùå Error clearing recipients:', err);
                showAlert('Network error while clearing recipients', 'danger');
            });
    }
}

// File upload placeholders (can be implemented later)
function showFromFileUpload() {
    console.log('üìÅ Opening file upload modal...');
    const modal = new bootstrap.Modal(document.getElementById('fromFileUploadModal'));
    
    // Reset modal state
    document.getElementById('fromFileInput').value = '';
    document.getElementById('fileInfoCard').classList.add('d-none');
    document.getElementById('uploadProgressSection').classList.add('d-none');
    document.getElementById('uploadSuccessAlert').classList.add('d-none');
    document.getElementById('fileSelectSection').classList.remove('d-none');
    document.getElementById('fileUploadStartBtn').disabled = true;
    document.getElementById('fileUploadCloseBtn').disabled = false;
    document.getElementById('fileUploadCancelBtn').disabled = false;
    
    modal.show();
}

let selectedFile = null;
let parsedEmails = [];

function handleFromFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    console.log(`üìÑ File selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
    selectedFile = file;
    
    // Show file info
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
    document.getElementById('emailsFound').textContent = 'Reading...';
    document.getElementById('fileInfoCard').classList.remove('d-none');
    
    // Parse file to count emails (chunked reading for large files)
    parseFileForEmails(file);
}

function parseFileForEmails(file) {
    console.log('üìñ Parsing file for email count...');
    const chunkSize = 1024 * 1024; // 1MB chunks
    let offset = 0;
    const emailSet = new Set();
    let buffer = '';
    
    const readChunk = () => {
        const slice = file.slice(offset, offset + chunkSize);
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const text = buffer + e.target.result;
            const lines = text.split('\n');
            
            // Keep last incomplete line in buffer
            buffer = lines.pop();
            
            // Process complete lines
            lines.forEach(line => {
                const email = line.trim();
                if (email && email.includes('@')) {
                    emailSet.add(email.toLowerCase());
                }
            });
            
            offset += chunkSize;
            
            // Continue reading or finish
            if (offset < file.size) {
                readChunk();
            } else {
                // Process last buffer
                if (buffer.trim() && buffer.includes('@')) {
                    emailSet.add(buffer.trim().toLowerCase());
                }
                
                parsedEmails = Array.from(emailSet);
                console.log(`‚úÖ Found ${parsedEmails.length} unique emails in file`);
                document.getElementById('emailsFound').textContent = parsedEmails.length.toLocaleString();
                document.getElementById('fileUploadStartBtn').disabled = false;
            }
        };
        
        reader.onerror = function() {
            console.error('‚ùå Error reading file');
            alert('Error reading file. Please try again.');
        };
        
        reader.readAsText(slice);
    };
    
    readChunk();
}

async function startFileUpload() {
    if (!selectedFile || parsedEmails.length === 0) {
        alert('Please select a valid file first');
        return;
    }
    
    console.log(`üöÄ Starting upload of ${parsedEmails.length} emails...`);
    
    // Update UI
    document.getElementById('fileSelectSection').classList.add('d-none');
    document.getElementById('uploadProgressSection').classList.remove('d-none');
    document.getElementById('fileUploadStartBtn').disabled = true;
    document.getElementById('fileUploadCloseBtn').disabled = true;
    document.getElementById('fileUploadCancelBtn').disabled = true;
    document.getElementById('uploadStatusText').textContent = 'Uploading emails to server...';
    
    // Parallel upload mode - REDUCED from 50 to 10 due to lock serialization on Render
    // With thread-safe locks, 50 parallel requests queue up causing 25s timeouts
    const chunkSize = 10000; // 10K emails per chunk
    const parallelLimit = 10; // REDUCED: Upload 10 chunks at once (was 50)
    let processed = 0;
    let added = 0;
    let duplicates = 0;
    let hasError = false;
    
    const totalChunks = Math.ceil(parsedEmails.length / chunkSize);
    const chunks = [];
    
    // Prepare all chunks
    for (let i = 0; i < parsedEmails.length; i += chunkSize) {
        chunks.push(parsedEmails.slice(i, i + chunkSize));
    }
    
    console.log(`üì¶ Split into ${totalChunks} chunks of ~${chunkSize} emails each`);
    console.log(`ÔøΩ Parallel upload mode: ${parallelLimit} chunks at a time for faster processing`);
    
    // Upload chunks in parallel batches
    for (let i = 0; i < chunks.length; i += parallelLimit) {
        if (hasError) break;
        
        const batch = chunks.slice(i, i + parallelLimit);
        const batchStart = i + 1;
        const batchEnd = Math.min(i + parallelLimit, chunks.length);
        
        console.log(`üì§ Uploading batch: chunks ${batchStart}-${batchEnd} of ${totalChunks}`);
        document.getElementById('uploadStatusText').textContent = 
            `Uploading chunks ${batchStart}-${batchEnd} of ${totalChunks}...`;
        
        // Upload all chunks in this batch concurrently
        const uploadPromises = batch.map((chunk, batchIndex) => {
            const chunkNum = i + batchIndex + 1;
            return uploadChunk(chunk, chunkNum, totalChunks);
        });
        
        try {
            const results = await Promise.all(uploadPromises);
            
            // Aggregate results
            results.forEach((result, idx) => {
                if (result.success) {
                    added += result.added;
                    duplicates += result.duplicates;
                    processed += batch[idx].length;
                    console.log(`‚úÖ Chunk ${i + idx + 1}/${totalChunks}: +${result.added} new, ${result.duplicates} duplicates`);
                } else {
                    console.error(`‚ùå Chunk ${i + idx + 1} failed: ${result.error}`);
                    hasError = true;
                }
            });
            
            // Update progress after batch
            const progress = (processed / parsedEmails.length * 100).toFixed(1);
            document.getElementById('uploadProgressBar').style.width = progress + '%';
            document.getElementById('uploadProgressText').textContent = progress + '%';
            document.getElementById('emailsProcessed').textContent = processed.toLocaleString();
            document.getElementById('emailsValid').textContent = added.toLocaleString();
            document.getElementById('emailsDuplicates').textContent = duplicates.toLocaleString();
            
        } catch (error) {
            console.error(`‚ùå Batch upload error:`, error);
            hasError = true;
            break;
        }
    }
    
    if (hasError) {
        alert(`Upload stopped. Processed: ${processed.toLocaleString()} emails, Added: ${added.toLocaleString()}`);
        document.getElementById('fileUploadCloseBtn').disabled = false;
        document.getElementById('fileUploadCancelBtn').disabled = false;
        document.getElementById('fileUploadCancelBtn').textContent = 'Close';
        document.getElementById('uploadStatusText').textContent = `‚ö†Ô∏è Upload incomplete`;
        return;
    }
    
    // Upload complete
    console.log(`‚úÖ Upload complete! Added ${added} emails, ${duplicates} duplicates removed`);
    document.getElementById('uploadSpinner').classList.add('d-none');
    document.getElementById('uploadStatusText').textContent = '‚úÖ Upload Complete!';
    document.getElementById('uploadProgressBar').classList.remove('progress-bar-animated');
    document.getElementById('uploadProgressBar').classList.add('bg-success');
    
    // Show success message
    document.getElementById('uploadSummary').innerHTML = `
        <ul class="mb-0">
            <li><strong>${added.toLocaleString()}</strong> new emails added</li>
            <li><strong>${duplicates.toLocaleString()}</strong> duplicates removed</li>
            <li><strong>${processed.toLocaleString()}</strong> total emails processed</li>
        </ul>
    `;
    document.getElementById('uploadSuccessAlert').classList.remove('d-none');
    
    // Refresh count with force refresh to bypass cache
    console.log('üîÑ Forcing count refresh after upload...');
    setTimeout(() => {
        loadFromEmails(true); // Force refresh = true
    }, 1000); // Increased delay to 1 second to ensure file is fully written
    
    // Re-enable close button
    document.getElementById('fileUploadCloseBtn').disabled = false;
    document.getElementById('fileUploadCancelBtn').disabled = false;
    document.getElementById('fileUploadCancelBtn').textContent = 'Close';
}

// Helper function to upload a single chunk
async function uploadChunk(chunk, chunkNum, totalChunks) {
    try {
        const controller = new AbortController();
        // INCREASED timeout from 25s to 60s to handle lock serialization delays
        // With locks, requests wait in queue - need longer timeout
        const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout
        
        const response = await fetch('/api/campaign/from/bulk', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({emails: chunk}),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.message || data.error || 'Upload failed');
        }
        
        return {
            success: true,
            added: data.added,
            duplicates: data.duplicates
        };
        
    } catch (error) {
        const errorMsg = error.name === 'AbortError' 
            ? 'Request timeout (60s limit exceeded)' 
            : error.message;
        
        return {
            success: false,
            error: errorMsg
        };
    }
}

function showRecipientsFileUpload() {
    alert('Feature coming soon: Direct file upload for emailx.txt');
}

// Start campaign
function startCampaign() {
    if (!confirm('Start campaign? This will begin sending emails.')) return;
    
    fetch('/api/campaign/start', {method: 'POST'})
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                campaignRunning = true;
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'inline-block';
                addConsoleLog('Campaign started...', 'success');
            } else {
                alert('Error: ' + data.error);
            }
        });
}

// Stop campaign
function stopCampaign() {
    if (!confirm('Stop campaign?')) return;
    
    fetch('/api/campaign/stop', {method: 'POST'})
        .then(res => res.json())
        .then(data => {
            campaignRunning = false;
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            addConsoleLog('Campaign stopped by user', 'warning');
        });
}

// Add console log
function addConsoleLog(message, type = 'info') {
    const console = document.getElementById('consoleOutput');
    const time = new Date().toLocaleTimeString();
    let color = '#d4d4d4';
    
    if (type === 'success') color = '#4ec9b0';
    else if (type === 'error') color = '#f48771';
    else if (type === 'warning') color = '#dcdcaa';
    
    const log = document.createElement('div');
    log.style.color = color;
    log.textContent = `[${time}] ${message}`;
    console.appendChild(log);
    console.scrollTop = console.scrollHeight;
}

// Clear console
function clearConsole() {
    document.getElementById('consoleOutput').innerHTML = '<div class="text-success">Console cleared.</div>';
}

// Update stats
function updateStats(stats) {
    if (stats.sent !== undefined) document.getElementById('sentCount').textContent = stats.sent;
    if (stats.failed !== undefined) document.getElementById('failedCount').textContent = stats.failed;
}

// Show alert
function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.getElementById('alertContainer').appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}

// Check campaign status on load
function checkCampaignStatus() {
    fetch('/api/campaign/stats')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                campaignRunning = data.running;
                
                if (data.running) {
                    // Campaign is running, update UI
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-block';
                    
                    // Load previous logs
                    if (data.logs && data.logs.length > 0) {
                        data.logs.forEach(log => {
                            addConsoleLog(log.message, log.type);
                        });
                    }
                    
                    // Update stats
                    updateStats(data.stats);
                    
                    addConsoleLog('Reconnected to running campaign...', 'success');
                } else {
                    document.getElementById('startBtn').style.display = 'inline-block';
                    document.getElementById('stopBtn').style.display = 'none';
                }
                
                // Update stats anyway
                if (data.stats) {
                    updateStats(data.stats);
                }
            }
        })
        .catch(err => console.error('Error checking campaign status:', err));
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Campaign page loaded - Initializing...');
    
    // Initialize socket first
    initCampaignSocket();
    
    // Load all data in parallel for faster page load
    Promise.all([
        new Promise(resolve => { loadConfig(); setTimeout(resolve, 100); }),
        new Promise(resolve => { loadFromEmails(); setTimeout(resolve, 100); }),
        new Promise(resolve => { loadRecipients(); setTimeout(resolve, 100); }),
        new Promise(resolve => { checkCampaignStatus(); setTimeout(resolve, 100); })
    ]).then(() => {
        // Hide loading overlay after all data loaded
        const overlay = document.getElementById('pageLoadingOverlay');
        if (overlay) {
            overlay.style.opacity = '0';
            overlay.style.transition = 'opacity 0.3s';
            setTimeout(() => overlay.remove(), 300);
        }
        console.log('‚úÖ Campaign page initialization complete');
        console.log('üì° Socket.IO handles real-time updates - no polling needed');
    }).catch(err => {
        console.error('‚ùå Initialization error:', err);
        // Hide overlay even on error
        const overlay = document.getElementById('pageLoadingOverlay');
        if (overlay) overlay.remove();
    });
    
    // Socket.IO handles real-time count updates during campaign
    // No polling needed - Socket.IO 'from_count_update' event updates counts automatically
});
</script>
{% endblock %}

