{% extends "base.html" %}

{% block title %}Campaign Settings - ALL-in-One Email Portal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h1><i class="bi bi-gear-fill"></i> Campaign Manager</h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-envelope-fill"></i> From Emails</h5>
                <h2 class="mb-0" id="fromCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-people-fill"></i> Recipients</h5>
                <h2 class="mb-0" id="recipientCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-send-fill"></i> Sent</h5>
                <h2 class="mb-0" id="sentCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-x-circle-fill"></i> Failed</h5>
                <h2 class="mb-0" id="failedCount">0</h2>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Tabs -->
<div class="row">
    <div class="col-12">
        <ul class="nav nav-tabs" id="campaignTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">
                    <i class="bi bi-gear"></i> Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="from-tab" data-bs-toggle="tab" data-bs-target="#from" type="button">
                    <i class="bi bi-envelope"></i> From Emails
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="recipients-tab" data-bs-toggle="tab" data-bs-target="#recipients" type="button">
                    <i class="bi bi-people"></i> Recipients
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="console-tab" data-bs-toggle="tab" data-bs-target="#console" type="button">
                    <i class="bi bi-terminal"></i> Console
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="campaignTabContent">
            <!-- Settings Tab -->
            <div class="tab-pane fade show active" id="settings" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div id="alertContainer"></div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Sender Name</label>
                                <input type="text" class="form-control" id="sendername" placeholder="Support">
                                <small class="text-muted">Display name for sender</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Subject</label>
                                <input type="text" class="form-control" id="subject" placeholder="Important Notice">
                                <small class="text-muted">Email subject line</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Message</label>
                                <textarea class="form-control" id="message" rows="5" placeholder="Enter your email message here..."></textarea>
                                <small class="text-muted">Email message body</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Domain From</label>
                                <input type="text" class="form-control" id="domainfrom" placeholder="charter.net">
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Domain Authentication</label>
                                <input type="text" class="form-control" id="domainauth" placeholder="altona.fr">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Sleep Time (seconds)</label>
                                <input type="number" class="form-control" id="sleeptime" placeholder="1">
                                <small class="text-muted">Delay between each email</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Threads</label>
                                <input type="number" class="form-control" id="threads" placeholder="3">
                                <small class="text-muted">Number of concurrent sending threads</small>
                            </div>
                        </div>
                        
                        <button class="btn btn-success mt-3" onclick="saveConfig()">
                            <i class="bi bi-save"></i> Save Configuration
                        </button>
                        <button class="btn btn-secondary mt-3" onclick="loadConfig()">
                            <i class="bi bi-arrow-clockwise"></i> Reload
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- From Emails Tab -->
            <div class="tab-pane fade" id="from" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0">From Email Addresses</h5>
                            <div>
                                <button class="btn btn-primary" onclick="showBulkFromModal()">
                                    <i class="bi bi-plus-circle"></i> Bulk Add
                                </button>
                                <button class="btn btn-danger" onclick="clearFromList()">
                                    <i class="bi bi-trash"></i> Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Note:</strong> For performance reasons, we don't display all from emails in the table. 
                            Use the statistics card above to see the total count.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h1 class="display-4 text-primary" id="fromCountLarge">0</h1>
                                        <p class="text-muted mb-0">Total From Emails</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="text-muted">Quick Actions</h6>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary" onclick="showBulkFromModal()">
                                                <i class="bi bi-file-earmark-arrow-up"></i> Upload/Paste From Emails
                                            </button>
                                            <button class="btn btn-outline-success" onclick="showFromFileUpload()">
                                                <i class="bi bi-cloud-upload"></i> Upload from.txt File
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="clearFromList()">
                                                <i class="bi bi-trash"></i> Delete All From Emails
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recipients Tab -->
            <div class="tab-pane fade" id="recipients" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0">Recipient Email Addresses</h5>
                            <div>
                                <button class="btn btn-primary" onclick="showBulkRecipientsModal()">
                                    <i class="bi bi-plus-circle"></i> Bulk Add
                                </button>
                                <button class="btn btn-danger" onclick="clearRecipientsList()">
                                    <i class="bi bi-trash"></i> Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Note:</strong> For performance reasons, we don't display all recipients in the table. 
                            Use the statistics card above to see the total count.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h1 class="display-4 text-info" id="recipientCountLarge">0</h1>
                                        <p class="text-muted mb-0">Total Recipients</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="text-muted">Quick Actions</h6>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary" onclick="showBulkRecipientsModal()">
                                                <i class="bi bi-file-earmark-arrow-up"></i> Upload/Paste Recipients
                                            </button>
                                            <button class="btn btn-outline-success" onclick="showRecipientsFileUpload()">
                                                <i class="bi bi-cloud-upload"></i> Upload emailx.txt File
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="clearRecipientsList()">
                                                <i class="bi bi-trash"></i> Delete All Recipients
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Console Tab -->
            <div class="tab-pane fade" id="console" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <h5>Campaign Console</h5>
                            <div>
                                <button class="btn btn-success" onclick="startCampaign()" id="startBtn">
                                    <i class="bi bi-play-fill"></i> Start Campaign
                                </button>
                                <button class="btn btn-danger" onclick="stopCampaign()" id="stopBtn" style="display:none;">
                                    <i class="bi bi-stop-fill"></i> Stop Campaign
                                </button>
                                <button class="btn btn-secondary" onclick="clearConsole()">
                                    <i class="bi bi-trash"></i> Clear
                                </button>
                            </div>
                        </div>
                        
                        <div id="consoleOutput" style="background-color: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; height: 600px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                            <div class="text-success">Console ready. Click "Start Campaign" to begin sending...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Add From Emails Modal -->
<div class="modal fade" id="bulkFromModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Add From Emails</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Paste email addresses (one per line). Duplicates will be removed automatically.</p>
                <textarea class="form-control" id="bulkFromInput" rows="15" placeholder="email1@example.com&#10;email2@example.com&#10;email3@example.com"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="processBulkFrom()">Add Emails</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Add Recipients Modal -->
<div class="modal fade" id="bulkRecipientsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Add Recipients</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Paste recipient email addresses (one per line). Duplicates will be removed automatically.</p>
                <textarea class="form-control" id="bulkRecipientsInput" rows="15" placeholder="recipient1@example.com&#10;recipient2@example.com&#10;recipient3@example.com"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="processBulkRecipients()">Add Emails</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let campaignSocket = null;
let campaignRunning = false;

// Initialize socket connection
function initCampaignSocket() {
    if (typeof io !== 'undefined') {
        campaignSocket = io();
        
        campaignSocket.on('campaign_log', function(data) {
            addConsoleLog(data.message, data.type || 'info');
        });
        
        campaignSocket.on('campaign_stats', function(data) {
            updateStats(data);
        });
        
        campaignSocket.on('campaign_complete', function(data) {
            campaignRunning = false;
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            addConsoleLog(`Campaign completed! Sent: ${data.sent}, Failed: ${data.failed}`, 'success');
            
            // Refresh from email count to show removed emails
            setTimeout(() => {
                loadFromEmails();
            }, 1000);
        });
    } else {
        setTimeout(initCampaignSocket, 100);
    }
}

// Load configuration
function loadConfig() {
    fetch('/api/config/get')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const config = data.config;
                document.getElementById('sendername').value = config.sendername || '';
                document.getElementById('subject').value = config.subject || '';
                document.getElementById('message').value = config.message || '';
                document.getElementById('domainfrom').value = config.domainfrom || '';
                document.getElementById('domainauth').value = config.domain_authentication || '';
                document.getElementById('sleeptime').value = config.sleeptime || '';
                document.getElementById('threads').value = config.threads || '';
            }
        })
        .catch(err => {
            showAlert('Error loading configuration: ' + err.message, 'danger');
        });
}

// Save configuration
function saveConfig() {
    const settings = {
        sendername: document.getElementById('sendername').value,
        subject: document.getElementById('subject').value,
        message: document.getElementById('message').value,
        domainfrom: document.getElementById('domainfrom').value,
        domain_authentication: document.getElementById('domainauth').value,
        sleeptime: document.getElementById('sleeptime').value,
        threads: document.getElementById('threads').value
    };
    
    fetch('/api/config/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(settings)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showAlert('Configuration saved successfully!', 'success');
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(err => {
        showAlert('Error saving configuration: ' + err.message, 'danger');
    });
}

// Load from emails
function loadFromEmails() {
    fetch('/api/campaign/from/list')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('fromCount').textContent = data.count;
                document.getElementById('fromCountLarge').textContent = data.count.toLocaleString();
            }
        });
}

// Load recipients
function loadRecipients() {
    fetch('/api/campaign/recipients/list')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('recipientCount').textContent = data.count;
                document.getElementById('recipientCountLarge').textContent = data.count.toLocaleString();
            }
        });
}

// Show bulk from modal
function showBulkFromModal() {
    const modal = new bootstrap.Modal(document.getElementById('bulkFromModal'));
    modal.show();
}

// Process bulk from emails
function processBulkFrom() {
    const input = document.getElementById('bulkFromInput').value;
    const emails = input.split('\n')
        .map(e => e.trim())
        .filter(e => e && e.includes('@'));
    
    if (emails.length === 0) {
        alert('No valid email addresses found');
        return;
    }
    
    fetch('/api/campaign/from/bulk', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({emails: emails})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('bulkFromModal')).hide();
            document.getElementById('bulkFromInput').value = '';
            loadFromEmails();
            showAlert(`Successfully added ${data.added} new emails. Total: ${data.total.toLocaleString()} (${data.duplicates} duplicates removed)`, 'success');
        }
    });
}

// Show bulk recipients modal
function showBulkRecipientsModal() {
    const modal = new bootstrap.Modal(document.getElementById('bulkRecipientsModal'));
    modal.show();
}

// Process bulk recipients
function processBulkRecipients() {
    const input = document.getElementById('bulkRecipientsInput').value;
    const emails = input.split('\n')
        .map(e => e.trim())
        .filter(e => e && e.includes('@'));
    
    if (emails.length === 0) {
        alert('No valid email addresses found');
        return;
    }
    
    fetch('/api/campaign/recipients/bulk', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({emails: emails})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('bulkRecipientsModal')).hide();
            document.getElementById('bulkRecipientsInput').value = '';
            loadRecipients();
            showAlert(`Successfully added ${data.added} new emails. Total: ${data.total.toLocaleString()} (${data.duplicates} duplicates removed)`, 'success');
        }
    });
}

// Clear from list
function clearFromList() {
    if (confirm('Are you sure you want to delete ALL from emails? This action cannot be undone!')) {
        fetch('/api/campaign/from/clear', {method: 'POST'})
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    loadFromEmails();
                    showAlert('All from emails have been deleted', 'warning');
                }
            });
    }
}

// Clear recipients list
function clearRecipientsList() {
    if (confirm('Are you sure you want to delete ALL recipients? This action cannot be undone!')) {
        fetch('/api/campaign/recipients/clear', {method: 'POST'})
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    loadRecipients();
                    showAlert('All recipients have been deleted', 'warning');
                }
            });
    }
}

// File upload placeholders (can be implemented later)
function showFromFileUpload() {
    alert('Feature coming soon: Direct file upload for from.txt');
}

function showRecipientsFileUpload() {
    alert('Feature coming soon: Direct file upload for emailx.txt');
}

// Start campaign
function startCampaign() {
    if (!confirm('Start campaign? This will begin sending emails.')) return;
    
    fetch('/api/campaign/start', {method: 'POST'})
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                campaignRunning = true;
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'inline-block';
                addConsoleLog('Campaign started...', 'success');
            } else {
                alert('Error: ' + data.error);
            }
        });
}

// Stop campaign
function stopCampaign() {
    if (!confirm('Stop campaign?')) return;
    
    fetch('/api/campaign/stop', {method: 'POST'})
        .then(res => res.json())
        .then(data => {
            campaignRunning = false;
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            addConsoleLog('Campaign stopped by user', 'warning');
        });
}

// Add console log
function addConsoleLog(message, type = 'info') {
    const console = document.getElementById('consoleOutput');
    const time = new Date().toLocaleTimeString();
    let color = '#d4d4d4';
    
    if (type === 'success') color = '#4ec9b0';
    else if (type === 'error') color = '#f48771';
    else if (type === 'warning') color = '#dcdcaa';
    
    const log = document.createElement('div');
    log.style.color = color;
    log.textContent = `[${time}] ${message}`;
    console.appendChild(log);
    console.scrollTop = console.scrollHeight;
}

// Clear console
function clearConsole() {
    document.getElementById('consoleOutput').innerHTML = '<div class="text-success">Console cleared.</div>';
}

// Update stats
function updateStats(stats) {
    if (stats.sent !== undefined) document.getElementById('sentCount').textContent = stats.sent;
    if (stats.failed !== undefined) document.getElementById('failedCount').textContent = stats.failed;
}

// Show alert
function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.getElementById('alertContainer').appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}

// Check campaign status on load
function checkCampaignStatus() {
    fetch('/api/campaign/stats')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                campaignRunning = data.running;
                
                if (data.running) {
                    // Campaign is running, update UI
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-block';
                    
                    // Load previous logs
                    if (data.logs && data.logs.length > 0) {
                        data.logs.forEach(log => {
                            addConsoleLog(log.message, log.type);
                        });
                    }
                    
                    // Update stats
                    updateStats(data.stats);
                    
                    addConsoleLog('Reconnected to running campaign...', 'success');
                } else {
                    document.getElementById('startBtn').style.display = 'inline-block';
                    document.getElementById('stopBtn').style.display = 'none';
                }
                
                // Update stats anyway
                if (data.stats) {
                    updateStats(data.stats);
                }
            }
        })
        .catch(err => console.error('Error checking campaign status:', err));
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initCampaignSocket();
    loadConfig();
    loadFromEmails();
    loadRecipients();
    checkCampaignStatus();
    
    // Poll for from email count updates every 10 seconds when campaign is running
    setInterval(() => {
        if (campaignRunning) {
            loadFromEmails();
        }
    }, 10000);
});
</script>
{% endblock %}

