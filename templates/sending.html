{% extends "base.html" %}

{% block title %}Sending - ALL-in-One Email Portal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="bi bi-send-fill"></i> Sending Campaign</h1>
                <p class="text-muted">Send emails using monitored from addresses</p>
            </div>
            <div>
                <span id="sendingStatusBadge" class="badge bg-secondary fs-6">
                    <i class="bi bi-stop-circle"></i> Stopped
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-check-circle"></i> Active Froms</h5>
                <h2 class="mb-0" id="activeFromsCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-secondary text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-x-circle"></i> Inactive Froms</h5>
                <h2 class="mb-0" id="inactiveFromsCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-people-fill"></i> Recipients</h5>
                <h2 class="mb-0" id="sendingRecipientsCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-send-check-fill"></i> Sent</h5>
                <h2 class="mb-0" id="sendingSentCount">0</h2>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Tabs -->
<div class="row">
    <div class="col-12">
        <ul class="nav nav-tabs" id="sendingTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="sending-settings-tab" data-bs-toggle="tab" data-bs-target="#sending-settings" type="button">
                    <i class="bi bi-gear"></i> Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="active-froms-tab" data-bs-toggle="tab" data-bs-target="#active-froms" type="button">
                    <i class="bi bi-check-circle"></i> Active Froms
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inactive-froms-tab" data-bs-toggle="tab" data-bs-target="#inactive-froms" type="button">
                    <i class="bi bi-x-circle"></i> Inactive Froms
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sending-recipients-tab" data-bs-toggle="tab" data-bs-target="#sending-recipients" type="button">
                    <i class="bi bi-people"></i> Recipients
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sending-console-tab" data-bs-toggle="tab" data-bs-target="#sending-console" type="button">
                    <i class="bi bi-terminal"></i> Console
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="sendingTabContent">
            <!-- Settings Tab -->
            <div class="tab-pane fade show active" id="sending-settings" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="mb-4"><i class="bi bi-gear"></i> Campaign Settings</h5>
                        <div id="sendingAlertContainer"></div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">From Email Source</label>
                                <select class="form-control" id="fromSource">
                                    <option value="active">Active Froms Only</option>
                                    <option value="inactive">Inactive Froms Only</option>
                                    <option value="all">All Froms (Active + Inactive)</option>
                                </select>
                                <small class="text-muted">Select which from emails to use</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Sender Name</label>
                                <input type="text" class="form-control" id="sendingSenderName" placeholder="Support">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Subject</label>
                                <input type="text" class="form-control" id="sendingSubject" placeholder="Important Notice">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Message</label>
                                <textarea class="form-control" id="sendingMessage" rows="5" placeholder="Enter your email message here..."></textarea>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Sleep Time (seconds)</label>
                                <input type="number" class="form-control" id="sendingSleepTime" value="1">
                                <small class="text-muted">Delay between emails</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Threads</label>
                                <input type="number" class="form-control" id="sendingThreads" value="1">
                                <small class="text-muted">Number of concurrent sending threads</small>
                            </div>
                        </div>
                        
                        <button class="btn btn-success mt-3" onclick="saveSendingSettings()">
                            <i class="bi bi-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Active Froms Tab -->
            <div class="tab-pane fade" id="active-froms" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Active From Emails</h5>
                            <div>
                                <button class="btn btn-sm btn-warning" onclick="moveSelectedToInactive()">
                                    <i class="bi bi-arrow-right"></i> Move Selected to Inactive
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="moveAllToInactive()">
                                    <i class="bi bi-arrow-right-circle"></i> Move All to Inactive
                                </button>
                                <button class="btn btn-sm btn-success" onclick="refreshActiveFroms()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAllActive" onchange="toggleSelectAllActive(this)">
                                        </th>
                                        <th>From Email</th>
                                        <th>Source Account</th>
                                        <th>Last Seen</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="activeFromsList">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="bi bi-inbox"></i> No active from emails yet
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Inactive Froms Tab -->
            <div class="tab-pane fade" id="inactive-froms" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Inactive From Emails</h5>
                            <div>
                                <button class="btn btn-sm btn-success" onclick="moveSelectedToActive()">
                                    <i class="bi bi-arrow-left"></i> Move Selected to Active
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="moveAllToActive()">
                                    <i class="bi bi-arrow-left-circle"></i> Move All to Active
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="refreshInactiveFroms()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAllInactive" onchange="toggleSelectAllInactive(this)">
                                        </th>
                                        <th>From Email</th>
                                        <th>Source Account</th>
                                        <th>Last Seen</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inactiveFromsList">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="bi bi-inbox"></i> No inactive from emails yet
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recipients Tab -->
            <div class="tab-pane fade" id="sending-recipients" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0">Recipients</h5>
                            <div>
                                <button class="btn btn-primary" onclick="showBulkRecipientsModal()">
                                    <i class="bi bi-plus-circle"></i> Bulk Add
                                </button>
                                <button class="btn btn-danger" onclick="clearSendingRecipients()">
                                    <i class="bi bi-trash"></i> Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h1 class="display-4 text-primary" id="sendingRecipientsCountLarge">0</h1>
                                        <p class="text-muted mb-0">Total Recipients</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Console Tab -->
            <div class="tab-pane fade" id="sending-console" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Campaign Console</h5>
                            <div>
                                <button class="btn btn-success" id="startSendingBtn" onclick="startSendingCampaign()">
                                    <i class="bi bi-play-fill"></i> Start Campaign
                                </button>
                                <button class="btn btn-danger" id="stopSendingBtn" style="display: none;" onclick="stopSendingCampaign()">
                                    <i class="bi bi-stop-fill"></i> Stop Campaign
                                </button>
                                <button class="btn btn-secondary" onclick="clearSendingConsole()">
                                    <i class="bi bi-trash"></i> Clear
                                </button>
                            </div>
                        </div>
                        
                        <div id="sendingConsole" class="console-output" style="height: 500px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 15px; font-family: 'Courier New', monospace; border-radius: 5px;">
                            <div class="text-muted">Campaign console ready. Click "Start Campaign" to begin...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Add Recipients Modal -->
<div class="modal fade" id="bulkRecipientsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Add Recipients</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="bulkRecipientsInput" rows="15" placeholder="Enter email addresses (one per line)"></textarea>
                <small class="text-muted">Duplicates will be automatically removed</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addBulkRecipients()">Add Recipients</button>
            </div>
        </div>
    </div>
</div>

<!-- Campaign Start Modal -->
<div class="modal fade" id="campaignStartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-rocket-takeoff-fill"></i> Start Sending Campaign</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="mb-3">Select which from emails to use:</h6>
                
                <div class="d-grid gap-3">
                    <button class="btn btn-lg btn-success text-start" onclick="confirmStartCampaign('active')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-check-circle-fill"></i> <strong>Active Froms Only</strong>
                            </div>
                            <span class="badge bg-white text-success fs-5" id="modalActiveCount">0</span>
                        </div>
                        <small class="text-white-50 d-block mt-1">Use only active from emails</small>
                    </button>
                    
                    <button class="btn btn-lg btn-secondary text-start" onclick="confirmStartCampaign('inactive')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-x-circle-fill"></i> <strong>Inactive Froms Only</strong>
                            </div>
                            <span class="badge bg-white text-secondary fs-5" id="modalInactiveCount">0</span>
                        </div>
                        <small class="text-white-50 d-block mt-1">Use only inactive from emails</small>
                    </button>
                    
                    <button class="btn btn-lg btn-primary text-start" onclick="confirmStartCampaign('all')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-circle-fill"></i> <strong>All Froms (Active + Inactive)</strong>
                            </div>
                            <span class="badge bg-white text-primary fs-5" id="modalTotalCount">0</span>
                        </div>
                        <small class="text-white-50 d-block mt-1">Use all available from emails</small>
                    </button>
                </div>
                
                <div class="alert alert-info mt-3 mb-0">
                    <i class="bi bi-info-circle"></i> <strong>Recipients:</strong> <span id="modalRecipientsCount">0</span> emails
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let monitoredFroms = {};
let sendingCampaignRunning = false;
let bulkRecipientsModal;
let campaignStartModal;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    bulkRecipientsModal = new bootstrap.Modal(document.getElementById('bulkRecipientsModal'));
    campaignStartModal = new bootstrap.Modal(document.getElementById('campaignStartModal'));
    loadMonitoredFroms();
    loadSendingRecipients();
    checkSendingStatus();
    
    // Periodic updates
    setInterval(loadMonitoredFroms, 30000); // Every 30 seconds
    setInterval(checkSendingStatus, 5000); // Every 5 seconds
});

// Socket.IO listener for new monitored emails
socket.on('new_monitored_email', function(data) {
    addToSendingConsole(`[NEW EMAIL] ${data.from} received in ${data.account}`, 'info');
    showNotification('New Email Monitored', `From: ${data.from}`);
    loadMonitoredFroms(); // Refresh data
});

// Socket.IO listener for sending campaign logs
socket.on('sending_campaign_log', function(data) {
    addToSendingConsole(data.message, data.type || 'info');
});

// Socket.IO listener for sending campaign stats
socket.on('sending_campaign_stats', function(data) {
    updateSendingStats(data);
});

// Socket.IO listener for sending campaign complete
socket.on('sending_campaign_complete', function(data) {
    addToSendingConsole(data.message, 'success');
    sendingCampaignRunning = false;
    updateSendingButtons();
});

function loadMonitoredFroms() {
    fetch('/api/monitored/froms')
        .then(response => response.json())
        .then(data => {
            monitoredFroms = data;
            updateMonitoredCounts();
            updateActiveFromsList();
            updateInactiveFromsList();
        })
        .catch(error => console.error('Error loading monitored froms:', error));
}

function updateMonitoredCounts() {
    let activeCount = 0;
    let inactiveCount = 0;
    
    Object.values(monitoredFroms).forEach(account => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'active') {
                activeCount++;
            } else {
                inactiveCount++;
            }
        });
    });
    
    document.getElementById('activeFromsCount').textContent = activeCount;
    document.getElementById('inactiveFromsCount').textContent = inactiveCount;
}

function updateActiveFromsList() {
    const tbody = document.getElementById('activeFromsList');
    tbody.innerHTML = '';
    
    let hasActive = false;
    Object.entries(monitoredFroms).forEach(([accountName, account]) => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'active') {
                hasActive = true;
                const row = `
                    <tr>
                        <td><input type="checkbox" class="active-from-checkbox" value="${fromEmail.email}"></td>
                        <td><strong>${fromEmail.email}</strong></td>
                        <td>${accountName}</td>
                        <td>${new Date(fromEmail.last_seen).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="toggleFromStatus('${fromEmail.email}', 'inactive')">
                                <i class="bi bi-x-circle"></i> Deactivate
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }
        });
    });
    
    if (!hasActive) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="bi bi-inbox"></i> No active from emails</td></tr>';
    }
}

function updateInactiveFromsList() {
    const tbody = document.getElementById('inactiveFromsList');
    tbody.innerHTML = '';
    
    let hasInactive = false;
    Object.entries(monitoredFroms).forEach(([accountName, account]) => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'inactive') {
                hasInactive = true;
                const row = `
                    <tr>
                        <td><input type="checkbox" class="inactive-from-checkbox" value="${fromEmail.email}"></td>
                        <td><strong>${fromEmail.email}</strong></td>
                        <td>${accountName}</td>
                        <td>${new Date(fromEmail.last_seen).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="toggleFromStatus('${fromEmail.email}', 'active')">
                                <i class="bi bi-check-circle"></i> Activate
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }
        });
    });
    
    if (!hasInactive) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="bi bi-inbox"></i> No inactive from emails</td></tr>';
    }
}

function toggleFromStatus(email, newStatus) {
    fetch('/api/sending/toggle_from', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            email: email,
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSendingAlert('success', `From email ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully`);
            loadMonitoredFroms();
        } else {
            showSendingAlert('danger', 'Error toggling from status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Error toggling from status');
    });
}

function refreshActiveFroms() {
    loadMonitoredFroms();
    showSendingAlert('info', 'Active froms refreshed');
}

function refreshInactiveFroms() {
    loadMonitoredFroms();
    showSendingAlert('info', 'Inactive froms refreshed');
}

function saveSendingSettings() {
    const settings = {
        from_source: document.getElementById('fromSource').value,
        sender_name: document.getElementById('sendingSenderName').value,
        subject: document.getElementById('sendingSubject').value,
        message: document.getElementById('sendingMessage').value,
        sleep_time: document.getElementById('sendingSleepTime').value,
        threads: document.getElementById('sendingThreads').value
    };
    
    fetch('/api/sending/save_settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSendingAlert('success', 'Settings saved successfully');
        } else {
            showSendingAlert('danger', 'Error saving settings');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Error saving settings');
    });
}

function showBulkRecipientsModal() {
    bulkRecipientsModal.show();
}

function addBulkRecipients() {
    const input = document.getElementById('bulkRecipientsInput').value;
    const emails = input.split('\n').map(e => e.trim()).filter(e => e);
    
    fetch('/api/sending/add_recipients', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ recipients: emails })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSendingAlert('success', `Added ${data.added} recipients (${data.duplicates} duplicates removed)`);
            document.getElementById('bulkRecipientsInput').value = '';
            bulkRecipientsModal.hide();
            loadSendingRecipients();
        } else {
            showSendingAlert('danger', 'Error adding recipients');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Error adding recipients');
    });
}

function clearSendingRecipients() {
    if (!confirm('Are you sure you want to clear all recipients?')) return;
    
    fetch('/api/sending/clear_recipients', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSendingAlert('success', 'Recipients cleared');
            loadSendingRecipients();
        } else {
            showSendingAlert('danger', 'Error clearing recipients');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Error clearing recipients');
    });
}

function loadSendingRecipients() {
    fetch('/api/sending/recipients')
        .then(response => response.json())
        .then(data => {
            document.getElementById('sendingRecipientsCount').textContent = data.count;
            document.getElementById('sendingRecipientsCountLarge').textContent = data.count;
        })
        .catch(error => console.error('Error loading recipients:', error));
}

function startSendingCampaign() {
    // Update modal counts
    let activeCount = 0;
    let inactiveCount = 0;
    
    Object.values(monitoredFroms).forEach(account => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'active') {
                activeCount++;
            } else {
                inactiveCount++;
            }
        });
    });
    
    document.getElementById('modalActiveCount').textContent = activeCount;
    document.getElementById('modalInactiveCount').textContent = inactiveCount;
    document.getElementById('modalTotalCount').textContent = activeCount + inactiveCount;
    document.getElementById('modalRecipientsCount').textContent = document.getElementById('sendingRecipientsCount').textContent;
    
    // Show modal
    campaignStartModal.show();
}

function confirmStartCampaign(fromSource) {
    campaignStartModal.hide();
    
    // Save from_source to settings first
    fetch('/api/sending/save_settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            from_source: fromSource,
            sender_name: document.getElementById('sendingSenderName').value,
            subject: document.getElementById('sendingSubject').value,
            message: document.getElementById('sendingMessage').value,
            sleep_time: document.getElementById('sendingSleepTime').value,
            threads: document.getElementById('sendingThreads').value
        })
    })
    .then(() => {
        // Start campaign
        return fetch('/api/sending/start', {
            method: 'POST'
        });
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sendingCampaignRunning = true;
            updateSendingButtons();
            addToSendingConsole(`Campaign started with ${fromSource} froms`, 'success');
            // Switch to console tab
            document.getElementById('sending-console-tab').click();
        } else {
            showSendingAlert('danger', data.message || 'Error starting campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Error starting campaign');
    });
}

function stopSendingCampaign() {
    if (!confirm('Stop the sending campaign?')) return;
    
    fetch('/api/sending/stop', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sendingCampaignRunning = false;
            updateSendingButtons();
            addToSendingConsole('Campaign stopped by user', 'warning');
        } else {
            showSendingAlert('danger', 'Error stopping campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Error stopping campaign');
    });
}

function checkSendingStatus() {
    fetch('/api/sending/status')
        .then(response => response.json())
        .then(data => {
            sendingCampaignRunning = data.running;
            updateSendingButtons();
            updateStatusBadge(data.running);
        })
        .catch(error => console.error('Error checking status:', error));
}

function updateSendingButtons() {
    if (sendingCampaignRunning) {
        document.getElementById('startSendingBtn').style.display = 'none';
        document.getElementById('stopSendingBtn').style.display = 'inline-block';
    } else {
        document.getElementById('startSendingBtn').style.display = 'inline-block';
        document.getElementById('stopSendingBtn').style.display = 'none';
    }
}

function updateStatusBadge(running) {
    const badge = document.getElementById('sendingStatusBadge');
    if (running) {
        badge.className = 'badge bg-success fs-6';
        badge.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span><i class="bi bi-play-fill"></i> Running';
    } else {
        badge.className = 'badge bg-secondary fs-6';
        badge.innerHTML = '<i class="bi bi-stop-circle"></i> Stopped';
    }
}

function updateSendingStats(data) {
    if (data.sent !== undefined) {
        document.getElementById('sendingSentCount').textContent = data.sent;
    }
}

function addToSendingConsole(message, type = 'info') {
    const console = document.getElementById('sendingConsole');
    const timestamp = new Date().toLocaleTimeString();
    
    let color = '#d4d4d4';
    let icon = 'ℹ️';
    
    if (type === 'success') {
        color = '#4ec9b0';
        icon = '✅';
    } else if (type === 'error') {
        color = '#f48771';
        icon = '❌';
    } else if (type === 'warning') {
        color = '#dcdcaa';
        icon = '⚠️';
    }
    
    const logEntry = `<div style="color: ${color}; margin-bottom: 5px;">[${timestamp}] ${icon} ${message}</div>`;
    console.innerHTML += logEntry;
    console.scrollTop = console.scrollHeight;
}

function clearSendingConsole() {
    document.getElementById('sendingConsole').innerHTML = '<div class="text-muted">Console cleared.</div>';
}

function showSendingAlert(type, message) {
    const alertContainer = document.getElementById('sendingAlertContainer');
    const alert = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    alertContainer.innerHTML = alert;
    setTimeout(() => {
        alertContainer.innerHTML = '';
    }, 5000);
}

function showNotification(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body: body });
    }
}

// Request notification permission
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}

// Checkbox selection functions
function toggleSelectAllActive(checkbox) {
    const checkboxes = document.querySelectorAll('.active-from-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
}

function toggleSelectAllInactive(checkbox) {
    const checkboxes = document.querySelectorAll('.inactive-from-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
}

// Bulk move functions
function moveSelectedToInactive() {
    const checkboxes = document.querySelectorAll('.active-from-checkbox:checked');
    if (checkboxes.length === 0) {
        showSendingAlert('warning', 'No emails selected');
        return;
    }
    
    if (!confirm(`Move ${checkboxes.length} email(s) to inactive?`)) return;
    
    const emails = Array.from(checkboxes).map(cb => cb.value);
    bulkToggleStatus(emails, 'inactive');
}

function moveSelectedToActive() {
    const checkboxes = document.querySelectorAll('.inactive-from-checkbox:checked');
    if (checkboxes.length === 0) {
        showSendingAlert('warning', 'No emails selected');
        return;
    }
    
    if (!confirm(`Move ${checkboxes.length} email(s) to active?`)) return;
    
    const emails = Array.from(checkboxes).map(cb => cb.value);
    bulkToggleStatus(emails, 'active');
}

function moveAllToInactive() {
    let activeEmails = [];
    Object.values(monitoredFroms).forEach(account => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'active') {
                activeEmails.push(fromEmail.email);
            }
        });
    });
    
    if (activeEmails.length === 0) {
        showSendingAlert('warning', 'No active emails to move');
        return;
    }
    
    if (!confirm(`Move all ${activeEmails.length} active email(s) to inactive?`)) return;
    
    bulkToggleStatus(activeEmails, 'inactive');
}

function moveAllToActive() {
    let inactiveEmails = [];
    Object.values(monitoredFroms).forEach(account => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'inactive') {
                inactiveEmails.push(fromEmail.email);
            }
        });
    });
    
    if (inactiveEmails.length === 0) {
        showSendingAlert('warning', 'No inactive emails to move');
        return;
    }
    
    if (!confirm(`Move all ${inactiveEmails.length} inactive email(s) to active?`)) return;
    
    bulkToggleStatus(inactiveEmails, 'active');
}

function bulkToggleStatus(emails, newStatus) {
    fetch('/api/sending/bulk_toggle', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            emails: emails,
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSendingAlert('success', `Moved ${data.count} email(s) to ${newStatus}`);
            loadMonitoredFroms();
            // Uncheck select all
            document.getElementById('selectAllActive').checked = false;
            document.getElementById('selectAllInactive').checked = false;
        } else {
            showSendingAlert('danger', 'Error moving emails');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Error moving emails');
    });
}
</script>
{% endblock %}
