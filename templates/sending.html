{% extends "base.html" %}

{% block title %}Sending - ALL-in-One Email Portal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="bi bi-send-fill"></i> Sending Campaign</h1>
                <p class="text-muted">Send emails using monitored from addresses</p>
            </div>
            <div>
                <span id="sendingStatusBadge" class="badge bg-secondary fs-6">
                    <i class="bi bi-stop-circle"></i> Stopped
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-check-circle"></i> Active Froms</h5>
                <h2 class="mb-0" id="activeFromsCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-secondary text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-x-circle"></i> Inactive Froms</h5>
                <h2 class="mb-0" id="inactiveFromsCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-people-fill"></i> Recipients</h5>
                <h2 class="mb-0" id="sendingRecipientsCount">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-send-check-fill"></i> Sent</h5>
                <h2 class="mb-0" id="sendingSentCount">0</h2>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Tabs -->
<div class="row">
    <div class="col-12">
        <ul class="nav nav-tabs" id="sendingTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="sending-settings-tab" data-bs-toggle="tab" data-bs-target="#sending-settings" type="button">
                    <i class="bi bi-gear"></i> Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="active-froms-tab" data-bs-toggle="tab" data-bs-target="#active-froms" type="button">
                    <i class="bi bi-check-circle"></i> Active Froms
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inactive-froms-tab" data-bs-toggle="tab" data-bs-target="#inactive-froms" type="button">
                    <i class="bi bi-x-circle"></i> Inactive Froms
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="recheck-froms-tab" data-bs-toggle="tab" data-bs-target="#recheck-froms" type="button">
                    <i class="bi bi-arrow-repeat"></i> Recheck Froms
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sending-recipients-tab" data-bs-toggle="tab" data-bs-target="#sending-recipients" type="button">
                    <i class="bi bi-people"></i> Recipients
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sending-console-tab" data-bs-toggle="tab" data-bs-target="#sending-console" type="button">
                    <i class="bi bi-terminal"></i> Console
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="sendingTabContent">
            <!-- Settings Tab -->
            <div class="tab-pane fade show active" id="sending-settings" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="mb-4"><i class="bi bi-gear"></i> Campaign Settings</h5>
                        <div id="sendingAlertContainer"></div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">From Email Source</label>
                                <select class="form-control" id="fromSource">
                                    <option value="active">Active Froms Only</option>
                                    <option value="inactive">Inactive Froms Only</option>
                                    <option value="all">All Froms (Active + Inactive)</option>
                                </select>
                                <small class="text-muted">Select which from emails to use</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Sender Name</label>
                                <input type="text" class="form-control" id="sendingSenderName" placeholder="Support">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Subject</label>
                                <input type="text" class="form-control" id="sendingSubject" placeholder="Important Notice">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Message</label>
                                <textarea class="form-control" id="sendingMessage" rows="5" placeholder="Enter your email message here..."></textarea>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Sleep Time (seconds)</label>
                                <input type="number" class="form-control" id="sendingSleepTime" value="1">
                                <small class="text-muted">Delay between emails</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Threads</label>
                                <input type="number" class="form-control" id="sendingThreads" value="1">
                                <small class="text-muted">Number of concurrent sending threads</small>
                            </div>
                        </div>
                        
                        <button class="btn btn-success mt-3" onclick="saveSendingSettings()">
                            <i class="bi bi-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Active Froms Tab -->
            <div class="tab-pane fade" id="active-froms" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Active From Emails</h5>
                            <div>
                                <button class="btn btn-sm btn-warning" onclick="moveSelectedToInactive()">
                                    <i class="bi bi-arrow-right"></i> Move Selected to Inactive
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="moveAllToInactive()">
                                    <i class="bi bi-arrow-right-circle"></i> Move All to Inactive
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSelectedActive()">
                                    <i class="bi bi-trash"></i> Delete Selected
                                </button>
                                <button class="btn btn-sm btn-dark" onclick="deleteAllActive()">
                                    <i class="bi bi-trash-fill"></i> Delete All
                                </button>
                                <button class="btn btn-sm btn-info" onclick="copyAllActive()">
                                    <i class="bi bi-clipboard"></i> Copy All
                                </button>
                                <button class="btn btn-sm btn-success" onclick="refreshActiveFroms()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAllActive" onchange="toggleSelectAllActive(this)">
                                        </th>
                                        <th>From Email</th>
                                        <th>Source Account</th>
                                        <th>Last Seen</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="activeFromsList">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="bi bi-inbox"></i> No active from emails yet
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Inactive Froms Tab -->
            <div class="tab-pane fade" id="inactive-froms" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Inactive From Emails</h5>
                            <div>
                                <button class="btn btn-sm btn-success" onclick="moveSelectedToActive()">
                                    <i class="bi bi-arrow-left"></i> Move Selected to Active
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="moveAllToActive()">
                                    <i class="bi bi-arrow-left-circle"></i> Move All to Active
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteSelectedInactive()">
                                    <i class="bi bi-trash"></i> Delete Selected
                                </button>
                                <button class="btn btn-sm btn-dark" onclick="deleteAllInactive()">
                                    <i class="bi bi-trash-fill"></i> Delete All
                                </button>
                                <button class="btn btn-sm btn-info" onclick="copyAllInactive()">
                                    <i class="bi bi-clipboard"></i> Copy All
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="refreshInactiveFroms()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAllInactive" onchange="toggleSelectAllInactive(this)">
                                        </th>
                                        <th>From Email</th>
                                        <th>Source Account</th>
                                        <th>Last Seen</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inactiveFromsList">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="bi bi-inbox"></i> No inactive from emails yet
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recipients Tab -->
            <div class="tab-pane fade" id="sending-recipients" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0">Recipients</h5>
                            <div>
                                <button class="btn btn-primary" onclick="showBulkRecipientsModal()">
                                    <i class="bi bi-plus-circle"></i> Bulk Add
                                </button>
                                <button class="btn btn-danger" onclick="clearSendingRecipients()">
                                    <i class="bi bi-trash"></i> Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h1 class="display-4 text-primary" id="sendingRecipientsCountLarge">0</h1>
                                        <p class="text-muted mb-0">Total Recipients</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Console Tab -->
            <div class="tab-pane fade" id="sending-console" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Campaign Console</h5>
                            <div>
                                <button class="btn btn-success" id="startSendingBtn" onclick="startSendingCampaign()">
                                    <i class="bi bi-play-fill"></i> Start Campaign
                                </button>
                                <button class="btn btn-danger" id="stopSendingBtn" style="display: none;" onclick="stopSendingCampaign()">
                                    <i class="bi bi-stop-fill"></i> Stop Campaign
                                </button>
                                <button class="btn btn-secondary" onclick="clearSendingConsole()">
                                    <i class="bi bi-trash"></i> Clear
                                </button>
                            </div>
                        </div>
                        
                        <div id="sendingConsole" class="console-output" style="height: 500px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 15px; font-family: 'Courier New', monospace; border-radius: 5px;">
                            <div class="text-muted">Campaign console ready. Click "Start Campaign" to begin...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recheck Froms Tab -->
            <div class="tab-pane fade" id="recheck-froms" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="mb-4"><i class="bi bi-arrow-repeat"></i> Recheck From Addresses</h5>
                        <p class="text-muted">Test which from addresses are working by sending verification emails</p>
                        
                        <div id="recheckAlertContainer"></div>
                        
                        <!-- Last Recheck Results Summary -->
                        <div id="recheckResultsSummary" style="display: none;" class="mb-4">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-check-circle-fill"></i> Last Recheck Results</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center mb-3">
                                        <div class="col-md-3">
                                            <div class="card bg-light">
                                                <div class="card-body py-2">
                                                    <h4 class="mb-0 text-primary" id="summaryTotalCount">0</h4>
                                                    <small class="text-muted">Total Tested</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-success text-white">
                                                <div class="card-body py-2">
                                                    <h4 class="mb-0" id="summaryWorkingCount">0</h4>
                                                    <small>‚úÖ Working</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-danger text-white">
                                                <div class="card-body py-2">
                                                    <h4 class="mb-0" id="summaryFailedCount">0</h4>
                                                    <small>‚ùå Failed</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-primary w-100 h-100" onclick="viewRecheckResults()">
                                                <i class="bi bi-eye-fill"></i> View Full Results
                                            </button>
                                        </div>
                                    </div>
                                    <p class="mb-0 text-muted small" id="summaryText">No recent recheck results available</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Configuration Form -->
                        <div class="row mb-4">
                            <div class="col-md-4 mb-3">
                                <label class="form-label"><strong>From Source to Test</strong></label>
                                <select class="form-control" id="recheckFromSource">
                                    <option value="active">Active Froms Only</option>
                                    <option value="inactive">Inactive Froms Only</option>
                                    <option value="all">Both (Active + Inactive)</option>
                                </select>
                                <small class="text-muted">Select which from addresses to test</small>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label"><strong>Concurrent Threads</strong></label>
                                <input type="number" class="form-control" id="recheckThreads" value="3" min="1" max="10">
                                <small class="text-muted">Number of parallel sending threads (1-10)</small>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label"><strong>Sender Name</strong></label>
                                <input type="text" class="form-control" id="recheckSenderName" value="Verification System" placeholder="Verification System">
                                <small class="text-muted">Name shown in "From" field</small>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-12 mb-3">
                                <label class="form-label"><strong>Subject Template</strong></label>
                                <input type="text" class="form-control" id="recheckSubject" value="Verification {unique_id}" placeholder="Verification {unique_id}">
                                <small class="text-muted">Variables: <code>{unique_id}</code>, <code>{from_email}</code>, <code>{timestamp}</code></small>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-12 mb-3">
                                <label class="form-label"><strong>Test Recipients (One per line)</strong></label>
                                <textarea class="form-control" id="recheckRecipients" rows="6" placeholder="Enter test email addresses">Footmen203@yahoo.com
Footmen404@yahoo.com
azoofoo2026@yahoo.com
azoofozora2026@yahoo.com
brb4mints@yahoo.com
atombrid2069@yahoo.com
micoland2026@yahoo.com
bravoeco2026@yahoo.com
laststand2026@yahoo.com
copermerv2026@yahoo.com</textarea>
                                <small class="text-muted">Test emails will be sent to these addresses</small>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-12 mb-3">
                                <label class="form-label"><strong>HTML Message Template</strong></label>
                                <textarea class="form-control" id="recheckMessage" rows="10" placeholder="HTML message" style="font-family: 'Courier New', monospace;"><!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px 10px 0 0; text-align: center;">
        <h1 style="margin: 0; font-size: 28px;">‚úâÔ∏è Email Verification</h1>
    </div>
    
    <div style="background: #ffffff; padding: 30px; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 10px 10px;">
        <h2 style="color: #667eea; margin-top: 0;">Verification Test</h2>
        
        <p style="font-size: 16px;">This is an automated verification email from:</p>
        
        <div style="background: #f8f9fa; padding: 15px; border-left: 4px solid #667eea; margin: 20px 0;">
            <strong style="color: #667eea;">From:</strong> {from_email}
        </div>
        
        <table style="width: 100%; margin: 20px 0; border-collapse: collapse;">
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #e0e0e0;"><strong>Test ID:</strong></td>
                <td style="padding: 10px; border-bottom: 1px solid #e0e0e0; font-family: monospace;">{unique_id}</td>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #e0e0e0;"><strong>Timestamp:</strong></td>
                <td style="padding: 10px; border-bottom: 1px solid #e0e0e0;">{timestamp}</td>
            </tr>
            <tr>
                <td style="padding: 10px;"><strong>Recipient:</strong></td>
                <td style="padding: 10px;">{recipient}</td>
            </tr>
        </table>
        
        <p style="color: #666; font-size: 14px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
            <em>This is an automated test email from the verification system. If this email reached your inbox, the sender address is working correctly.</em>
        </p>
    </div>
    
    <div style="text-align: center; margin-top: 20px; color: #999; font-size: 12px;">
        <p>Automated Email Verification System</p>
    </div>
</body>
</html></textarea>
                                <small class="text-muted">HTML template with variables: <code>{from_email}</code>, <code>{unique_id}</code>, <code>{timestamp}</code>, <code>{recipient}</code></small>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button class="btn btn-primary" onclick="saveRecheckConfig()">
                                    <i class="bi bi-save"></i> Save Configuration
                                </button>
                            </div>
                            <div>
                                <button class="btn btn-success btn-lg" onclick="showRecheckFromSourceModal()" id="startRecheckBtn">
                                    <i class="bi bi-play-circle-fill"></i> Start Recheck Campaign
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Add Recipients Modal -->
<div class="modal fade" id="bulkRecipientsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Add Recipients</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="bulkRecipientsInput" rows="15" placeholder="Enter email addresses (one per line)"></textarea>
                <small class="text-muted">Duplicates will be automatically removed</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addBulkRecipients()">Add Recipients</button>
            </div>
        </div>
    </div>
</div>

<!-- Campaign Start Modal -->
<div class="modal fade" id="campaignStartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-rocket-takeoff-fill"></i> Start Sending Campaign</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="mb-3">Select which from emails to use:</h6>
                
                <div class="d-grid gap-3">
                    <button class="btn btn-lg btn-success text-start" onclick="confirmStartCampaign('active')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-check-circle-fill"></i> <strong>Active Froms Only</strong>
                            </div>
                            <span class="badge bg-white text-success fs-5" id="modalActiveCount">0</span>
                        </div>
                        <small class="text-white-50 d-block mt-1">Use only active from emails</small>
                    </button>
                    
                    <button class="btn btn-lg btn-secondary text-start" onclick="confirmStartCampaign('inactive')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-x-circle-fill"></i> <strong>Inactive Froms Only</strong>
                            </div>
                            <span class="badge bg-white text-secondary fs-5" id="modalInactiveCount">0</span>
                        </div>
                        <small class="text-white-50 d-block mt-1">Use only inactive from emails</small>
                    </button>
                    
                    <button class="btn btn-lg btn-primary text-start" onclick="confirmStartCampaign('all')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-circle-fill"></i> <strong>All Froms (Active + Inactive)</strong>
                            </div>
                            <span class="badge bg-white text-primary fs-5" id="modalTotalCount">0</span>
                        </div>
                        <small class="text-white-50 d-block mt-1">Use all available from emails</small>
                    </button>
                </div>
                
                <div class="alert alert-info mt-3 mb-0">
                    <i class="bi bi-info-circle"></i> <strong>Recipients:</strong> <span id="modalRecipientsCount">0</span> emails
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recheck Progress Modal -->
<div class="modal fade" id="recheckProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-repeat spin-animation"></i> Recheck Campaign Running
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" id="closeRecheckModal" style="display: none;"></button>
            </div>
            <div class="modal-body">
                <!-- Phase 1: Sending -->
                <div id="recheckPhase1" class="mb-4">
                    <div class="row">
                        <div class="col-md-9">
                            <h6 class="text-primary"><i class="bi bi-send-fill"></i> Phase 1: Sending Test Emails</h6>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                     id="recheckSendingProgress" 
                                     role="progressbar" 
                                     style="width: 0%">
                                    <span id="recheckSendingText">0/0 (0%)</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <h6 class="text-success">‚úÖ Confirmed Working</h6>
                            <div class="display-4 text-success fw-bold" id="recheckBatchCountdown">0</div>
                            <small class="text-muted">from emails</small>
                        </div>
                    </div>
                </div>
                
                <!-- Phase 2: Waiting -->
                <div id="recheckPhase2" class="mb-4" style="display: none;">
                    <h6 class="text-success"><i class="bi bi-hourglass-split"></i> Phase 2: Waiting for Responses</h6>
                    <div class="alert alert-success">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-clock-fill"></i> <strong>Time Remaining:</strong>
                            </div>
                            <div>
                                <span class="fs-4" id="recheckCountdown">5:00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Statistics -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-success text-white text-center">
                            <div class="card-body py-2">
                                <h3 class="mb-0" id="recheckWorkingCount">0</h3>
                                <small>‚úÖ Working</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-warning text-white text-center">
                            <div class="card-body py-2">
                                <h3 class="mb-0" id="recheckPendingCount">0</h3>
                                <small>‚è≥ Pending</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-danger text-white text-center">
                            <div class="card-body py-2">
                                <h3 class="mb-0" id="recheckFailedCount">0</h3>
                                <small>‚ùå Failed</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Activity Log -->
                <div class="row">
                    <div class="col-md-8">
                        <h6><i class="bi bi-list-ul"></i> Latest Activity</h6>
                        <div id="recheckActivityLog" 
                             style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 12px;">
                            <div class="text-muted">Initializing...</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-check-circle-fill text-success"></i> Working Froms</h6>
                            <button class="btn btn-sm btn-success" onclick="copyWorkingEmails()" title="Copy all working emails">
                                <i class="bi bi-clipboard"></i> Copy All
                            </button>
                        </div>
                        <textarea id="recheckWorkingLog" readonly
                                  style="height: 180px; width: 100%; background: #d1f2dd; padding: 10px; border: 1px solid #28a745; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 11px; resize: none;"
                                  placeholder="Working from emails will appear here..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="stopRecheckCampaign()" id="stopRecheckBtn">
                    <i class="bi bi-stop-circle-fill"></i> Stop Campaign
                </button>
                <button type="button" class="btn btn-primary" onclick="viewRecheckResults()" id="viewResultsBtn" style="display: none;">
                    <i class="bi bi-eye-fill"></i> View Full Results
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Recheck Results Modal -->
<div class="modal fade" id="recheckResultsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle-fill"></i> Recheck Results
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <strong>Campaign Summary:</strong> 
                            <span id="resultsSummaryText"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Real-time Captured Working Emails -->
                <div class="row mb-3" id="realTimeWorkingSection" style="display: none;">
                    <div class="col-md-12">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-lightning-fill"></i> Real-Time Captured Working Emails
                                        <span class="badge bg-light text-success ms-2" id="realTimeWorkingCount">0</span>
                                    </h6>
                                    <button class="btn btn-sm btn-light" onclick="copyRealTimeWorking()">
                                        <i class="bi bi-clipboard"></i> Copy All
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-2">
                                <textarea id="realTimeWorkingEmails" readonly
                                          class="form-control font-monospace"
                                          style="height: 150px; background: #d1f2dd; border: 1px solid #28a745; font-size: 11px; resize: vertical;"
                                          placeholder="Working emails detected in real-time will appear here..."></textarea>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> These are all emails detected during the campaign, even if stopped early. 
                                    Use this list to replace your active froms.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <ul class="nav nav-tabs mb-3" id="resultsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="working-tab" data-bs-toggle="tab" data-bs-target="#working-results" type="button">
                            <i class="bi bi-check-circle-fill text-success"></i> Working (<span id="workingTabCount">0</span>)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="failed-tab" data-bs-toggle="tab" data-bs-target="#failed-results" type="button">
                            <i class="bi bi-x-circle-fill text-danger"></i> Failed (<span id="failedTabCount">0</span>)
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="working-results" role="tabpanel">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-striped table-hover">
                                <thead class="table-success sticky-top">
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" id="selectAllWorking" onchange="toggleSelectAllWorking()">
                                        </th>
                                        <th>From Email</th>
                                        <th>Sent At</th>
                                        <th>Delivered At</th>
                                        <th>Response Time</th>
                                    </tr>
                                </thead>
                                <tbody id="workingResultsTable">
                                    <tr><td colspan="5" class="text-center text-muted">No working froms yet...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="failed-results" role="tabpanel">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-striped table-hover">
                                <thead class="table-danger sticky-top">
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" id="selectAllFailed" onchange="toggleSelectAllFailed()">
                                        </th>
                                        <th>From Email</th>
                                        <th>Sent At</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="failedResultsTable">
                                    <tr><td colspan="4" class="text-center text-muted">No failed froms yet...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <button class="btn btn-primary btn-lg" onclick="replaceActiveFroms()">
                        <i class="bi bi-arrow-repeat"></i> Replace Active Froms
                        <small class="d-block" style="font-size: 0.75rem;">Move old active ‚Üí inactive, new working ‚Üí active</small>
                    </button>
                    <button class="btn btn-success" onclick="moveWorkingToActive()">
                        <i class="bi bi-arrow-right-circle-fill"></i> Move Working to Active
                    </button>
                    <button class="btn btn-secondary" onclick="moveFailedToInactive()">
                        <i class="bi bi-arrow-left-circle-fill"></i> Move Failed to Inactive
                    </button>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Recheck From Source Selection Modal -->
<div class="modal fade" id="recheckFromSourceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-arrow-repeat"></i> Select From Emails to Recheck</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="mb-3">Which from emails should be tested?</h6>
                
                <div class="d-grid gap-3">
                    <button class="btn btn-lg btn-success text-start" onclick="confirmStartRecheck('active')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-check-circle-fill"></i> <strong>Active Froms Only</strong>
                            </div>
                            <span class="badge bg-white text-success fs-5" id="recheckModalActiveCount">0</span>
                        </div>
                        <small class="text-white-50 d-block mt-1">Test only active from emails</small>
                    </button>
                    
                    <button class="btn btn-lg btn-secondary text-start" onclick="confirmStartRecheck('inactive')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-x-circle-fill"></i> <strong>Inactive Froms Only</strong>
                            </div>
                            <span class="badge bg-white text-secondary fs-5" id="recheckModalInactiveCount">0</span>
                        </div>
                        <small class="text-white-50 d-block mt-1">Test only inactive from emails</small>
                    </button>
                    
                    <button class="btn btn-lg btn-primary text-start" onclick="confirmStartRecheck('all')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-arrow-left-right"></i> <strong>All Froms</strong>
                            </div>
                            <span class="badge bg-white text-primary fs-5" id="recheckModalAllCount">0</span>
                        </div>
                        <small class="text-white-50 d-block mt-1">Test both active and inactive</small>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.spin-animation {
    animation: spin 2s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
}
</style>

{% endblock %}

{% block extra_js %}
<script>
let monitoredFroms = {};
let sendingCampaignRunning = false;
let bulkRecipientsModal;
let campaignStartModal;
let tabsLoaded = {}; // Track which tabs have been loaded

// Performance logging utility
function logPerformance(operation, startTime) {
    const duration = (performance.now() - startTime).toFixed(2);
    console.log(`‚è±Ô∏è ${operation} took ${duration}ms`);
    return duration;
}

// Initialize - Load counts immediately, full data on tab clicks
document.addEventListener('DOMContentLoaded', function() {
    const initStart = performance.now();
    console.log('üöÄ Initializing Sending page...');
    
    bulkRecipientsModal = new bootstrap.Modal(document.getElementById('bulkRecipientsModal'));
    campaignStartModal = new bootstrap.Modal(document.getElementById('campaignStartModal'));
    
    // Load recheck config silently (lightweight)
    loadRecheckConfig();
    
    // Setup tab change listeners for lazy loading
    setupTabLazyLoading();
    
    // Load monitored froms data for counts ONLY (don't render lists yet)
    console.log('üìä Loading initial counts (not rendering lists)...');
    loadMonitoredFroms(false).then(() => {
        console.log('‚úÖ Page initialized with counts loaded');
        logPerformance('Page initialization', initStart);
    });
    
    // Mark Settings tab as loaded (default visible tab)
    tabsLoaded['settings'] = true;
    
    // NO automatic intervals - only reload when user interacts
});

// Setup lazy loading on tab clicks
function setupTabLazyLoading() {
    console.log('üìë Setting up lazy tab loading...');
    
    // Listen for tab changes
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const tabId = e.target.getAttribute('data-bs-target');
            const tabName = e.target.textContent.trim();
            
            console.log(`üëÜ Tab clicked: ${tabName} (${tabId})`);
            const tabStart = performance.now();
            
            // Load data for specific tab ONLY when clicked
            if (tabId === '#settings-tab-pane') {
                // Settings tab - already loaded
                console.log('‚öôÔ∏è Settings tab (static, no data needed)');
            } else if (tabId === '#active-froms-tab-pane') {
                if (!tabsLoaded['active']) {
                    loadActiveFromsTab();
                    tabsLoaded['active'] = true;
                } else {
                    console.log('üíæ Using cached active froms');
                }
            } else if (tabId === '#inactive-froms-tab-pane') {
                if (!tabsLoaded['inactive']) {
                    loadInactiveFromsTab();
                    tabsLoaded['inactive'] = true;
                } else {
                    console.log('üíæ Using cached inactive froms');
                }
            } else if (tabId === '#recheck-froms-tab-pane') {
                if (!tabsLoaded['recheck']) {
                    loadRecheckTab();
                    tabsLoaded['recheck'] = true;
                } else {
                    console.log('üíæ Using cached recheck results');
                }
            } else if (tabId === '#recipients-tab-pane') {
                if (!tabsLoaded['recipients']) {
                    loadRecipientsTab();
                    tabsLoaded['recipients'] = true;
                } else {
                    console.log('üíæ Using cached recipients');
                }
            } else if (tabId === '#console-tab-pane') {
                console.log('üìã Console tab (static)');
            }
            
            logPerformance(`Tab switch to ${tabName}`, tabStart);
        });
    });
}

// Load active froms tab data only
function loadActiveFromsTab() {
    const start = performance.now();
    console.log('üì• Loading active froms tab...');
    
    // If data already loaded, just render the list
    if (Object.keys(monitoredFroms).length > 0) {
        console.log('üìä Data exists, rendering active list...');
        updateActiveFromsList();
        logPerformance('Render active froms list', start);
    } else {
        // First time - need to fetch data
        console.log('üîÑ Fetching data for active froms...');
        loadMonitoredFroms(true).then(() => {
            logPerformance('Load active froms', start);
        });
    }
}

// Load inactive froms tab data only
function loadInactiveFromsTab() {
    const start = performance.now();
    console.log('üì• Loading inactive froms tab...');
    
    // If data already loaded, just render the list
    if (Object.keys(monitoredFroms).length > 0) {
        console.log('üìä Data exists, rendering inactive list...');
        updateInactiveFromsList();
        logPerformance('Render inactive froms list', start);
    } else {
        // First time - need to fetch data
        console.log('üîÑ Fetching data for inactive froms...');
        loadMonitoredFroms(true).then(() => {
            logPerformance('Load inactive froms', start);
        });
    }
}

// Load recipients tab data only
function loadRecipientsTab() {
    const start = performance.now();
    console.log('üì• Loading recipients...');
    
    // Show loading on count only
    document.getElementById('sendingRecipientsCount').innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    loadSendingRecipients().then(() => {
        logPerformance('Load recipients', start);
    });
}

// Load recheck tab data only
function loadRecheckTab() {
    const start = performance.now();
    console.log('üì• Loading recheck results...');
    
    // Try to load existing results from backend
    fetch('/api/recheck/results')
        .then(res => res.json())
        .then(data => {
            if (data.success && data.results) {
                const working = data.results.working || [];
                const failed = data.results.failed || [];
                const total = working.length + failed.length;
                
                if (total > 0) {
                    console.log(`üìä Found ${total} recheck results (${working.length} working, ${failed.length} failed)`);
                    recheckResults = data.results;
                    
                    // Show and update summary in tab
                    document.getElementById('recheckResultsSummary').style.display = 'block';
                    document.getElementById('summaryTotalCount').textContent = total;
                    document.getElementById('summaryWorkingCount').textContent = working.length;
                    document.getElementById('summaryFailedCount').textContent = failed.length;
                    document.getElementById('summaryText').textContent = 
                        `Tested ${total} from addresses: ${working.length} working, ${failed.length} failed`;
                } else {
                    console.log('üí§ No recheck results available yet');
                    document.getElementById('recheckResultsSummary').style.display = 'none';
                }
            } else {
                console.log('üí§ No recheck results available yet');
                document.getElementById('recheckResultsSummary').style.display = 'none';
            }
            logPerformance('Load recheck results', start);
        })
        .catch(err => {
            console.error('‚ùå Error loading recheck results:', err);
            document.getElementById('recheckResultsSummary').style.display = 'none';
            logPerformance('Load recheck results (error)', start);
        });
}

// Socket.IO listeners (check if socket is available from base.html)
if (typeof socket !== 'undefined') {
    console.log('üîå Socket.IO available - setting up listeners');
    
    // Socket.IO listener for new monitored emails
    socket.on('new_monitored_email', function(data) {
        console.log('üìß Socket: New email detected:', data.from);
        const start = performance.now();
        
        addToSendingConsole(`[NEW EMAIL] ${data.from} received in ${data.account}`, 'info');
        
        // Only reload if active/inactive tabs are visible
        const activeTab = document.querySelector('#active-froms-tab-pane.active, #inactive-froms-tab-pane.active');
        if (activeTab) {
            console.log('üîÑ Reloading froms due to new email...');
            tabsLoaded['active'] = false;  // Invalidate cache
            tabsLoaded['inactive'] = false;
            loadMonitoredFroms();
        } else {
            console.log('üí§ Skipped reload (tab not visible)');
        }
        
        logPerformance('Socket new_monitored_email handler', start);
    });

    // Socket.IO listener for sending campaign logs
    socket.on('sending_campaign_log', function(data) {
        console.log('üìù Socket: Campaign log:', data.message);
        addToSendingConsole(data.message, data.log_type || 'info');
    });

    // Socket.IO listener for sending campaign stats
    socket.on('sending_campaign_stats', function(data) {
        console.log('üìä Socket: Campaign stats update');
        updateSendingStats(data);
    });

    // Socket.IO listener for sending campaign complete
    socket.on('sending_campaign_complete', function(data) {
        console.log('‚úÖ Socket: Campaign complete');
        addToSendingConsole(data.message, 'success');
        sendingCampaignRunning = false;
        updateSendingButtons();
    });
} else {
    console.warn('‚ö†Ô∏è Socket.IO not available - real-time updates disabled');
}

// Loading indicator utilities
function showLoadingIndicator(elementId, message = 'Loading...') {
    const element = document.getElementById(elementId);
    if (element && element.tagName === 'TBODY') {
        element.innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-4">
                    <div class="spinner-border spinner-border-sm text-primary mb-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="text-muted small">${message}</div>
                </td>
            </tr>
        `;
    }
}

function showLoadingSpinner(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = `
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        `;
    }
}

let lastFromsLoad = 0;
const FROMS_CACHE_TIME = 5000; // 5 seconds cache

function loadMonitoredFroms(renderLists = true) {
    const start = performance.now();
    
    // Throttle: Don't reload if loaded recently
    const now = Date.now();
    if (now - lastFromsLoad < FROMS_CACHE_TIME) {
        console.log('‚ö° Skipped load (using 5s cache)');
        return Promise.resolve();
    }
    lastFromsLoad = now;
    
    console.log('üîÑ Fetching from emails from API...');
    
    // Show loading on BOTH counts (might be called from either tab)
    const activeCount = document.getElementById('activeFromsCount');
    const inactiveCount = document.getElementById('inactiveFromsCount');
    if (activeCount) activeCount.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    if (inactiveCount) inactiveCount.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    return fetch('/api/monitored/froms')
        .then(response => {
            const fetchDuration = logPerformance('API fetch /api/monitored/froms', start);
            return response.json();
        })
        .then(data => {
            const parseStart = performance.now();
            monitoredFroms = data;
            updateMonitoredCounts();
            
            // Only render lists if requested (for initial load, skip rendering)
            if (renderLists) {
                updateActiveFromsList();
                updateInactiveFromsList();
            } else {
                console.log('üìä Counts updated (lists not rendered)');
            }
            
            logPerformance('Parse and render from emails', parseStart);
            logPerformance('Total loadMonitoredFroms', start);
        })
        .catch(error => {
            console.error('‚ùå Error loading monitored froms:', error);
            if (activeCount) activeCount.textContent = '?';
            if (inactiveCount) inactiveCount.textContent = '?';
        });
}

function updateMonitoredCounts() {
    const start = performance.now();
    let activeCount = 0;
    let inactiveCount = 0;
    
    Object.values(monitoredFroms).forEach(account => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'active') {
                activeCount++;
            } else {
                inactiveCount++;
            }
        });
    });
    
    document.getElementById('activeFromsCount').textContent = activeCount;
    document.getElementById('inactiveFromsCount').textContent = inactiveCount;
    
    console.log(`üìä Counts: ${activeCount} active, ${inactiveCount} inactive`);
    logPerformance('updateMonitoredCounts', start);
}

function updateActiveFromsList() {
    const start = performance.now();
    const tbody = document.getElementById('activeFromsList');
    tbody.innerHTML = '';
    
    let count = 0;
    
    let hasActive = false;
    Object.entries(monitoredFroms).forEach(([accountName, account]) => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'active') {
                hasActive = true;
                const row = `
                    <tr>
                        <td><input type="checkbox" class="active-from-checkbox" value="${fromEmail.email}"></td>
                        <td><strong>${fromEmail.email}</strong></td>
                        <td>${accountName}</td>
                        <td>${new Date(fromEmail.last_seen).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="toggleFromStatus('${fromEmail.email}', 'inactive')">
                                <i class="bi bi-x-circle"></i> Deactivate
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
                count++;
            }
        });
    });
    
    if (!hasActive) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="bi bi-inbox"></i> No active from emails</td></tr>';
    }
    
    console.log(`üìã Rendered ${count} active froms`);
    logPerformance('updateActiveFromsList', start);
}

function updateInactiveFromsList() {
    const start = performance.now();
    const tbody = document.getElementById('inactiveFromsList');
    tbody.innerHTML = '';
    
    let hasInactive = false;
    let count = 0;
    Object.entries(monitoredFroms).forEach(([accountName, account]) => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'inactive') {
                hasInactive = true;
                count++;
                const row = `
                    <tr>
                        <td><input type="checkbox" class="inactive-from-checkbox" value="${fromEmail.email}"></td>
                        <td><strong>${fromEmail.email}</strong></td>
                        <td>${accountName}</td>
                        <td>${new Date(fromEmail.last_seen).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="toggleFromStatus('${fromEmail.email}', 'active')">
                                <i class="bi bi-check-circle"></i> Activate
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }
        });
    });
    
    if (!hasInactive) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="bi bi-inbox"></i> No inactive from emails</td></tr>';
    }
    
    console.log(`üìã Rendered ${count} inactive froms`);
    logPerformance('updateInactiveFromsList', start);
}

function toggleFromStatus(email, newStatus) {
    const start = performance.now();
    console.log(`üîÑ Toggling ${email} to ${newStatus}...`);
    
    fetch('/api/sending/toggle_from', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            email: email,
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logPerformance('Toggle from status', start);
            showSendingAlert('success', `From email ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully`);
            
            // Invalidate cache and reload
            tabsLoaded['active'] = false;
            tabsLoaded['inactive'] = false;
            loadMonitoredFroms();
        } else {
            console.error('‚ùå Toggle failed:', data);
            showSendingAlert('danger', 'Error toggling from status');
        }
    })
    .catch(error => {
        console.error('‚ùå Toggle error:', error);
        showSendingAlert('danger', 'Error toggling from status');
    });
}

function refreshActiveFroms() {
    loadMonitoredFroms();
    showSendingAlert('info', 'Active froms refreshed');
}

function refreshInactiveFroms() {
    loadMonitoredFroms();
    showSendingAlert('info', 'Inactive froms refreshed');
}

function saveSendingSettings() {
    const settings = {
        from_source: document.getElementById('fromSource').value,
        sender_name: document.getElementById('sendingSenderName').value,
        subject: document.getElementById('sendingSubject').value,
        message: document.getElementById('sendingMessage').value,
        sleep_time: document.getElementById('sendingSleepTime').value,
        threads: document.getElementById('sendingThreads').value
    };
    
    fetch('/api/sending/save_settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSendingAlert('success', 'Settings saved successfully');
        } else {
            showSendingAlert('danger', 'Error saving settings');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Error saving settings');
    });
}

function showBulkRecipientsModal() {
    bulkRecipientsModal.show();
}

function addBulkRecipients() {
    const input = document.getElementById('bulkRecipientsInput').value;
    const emails = input.split('\n').map(e => e.trim()).filter(e => e);
    
    fetch('/api/sending/add_recipients', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ recipients: emails })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSendingAlert('success', `Added ${data.added} recipients (${data.duplicates} duplicates removed)`);
            document.getElementById('bulkRecipientsInput').value = '';
            bulkRecipientsModal.hide();
            loadSendingRecipients();
        } else {
            showSendingAlert('danger', 'Error adding recipients');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Error adding recipients');
    });
}

function clearSendingRecipients() {
    if (!confirm('Are you sure you want to clear all recipients?')) return;
    
    fetch('/api/sending/clear_recipients', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSendingAlert('success', 'Recipients cleared');
            loadSendingRecipients();
        } else {
            showSendingAlert('danger', 'Error clearing recipients');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Error clearing recipients');
    });
}

function loadSendingRecipients() {
    const start = performance.now();
    console.log('üîÑ Fetching recipients from API...');
    
    // Show loading in count badges
    const countElement = document.getElementById('sendingRecipientsCount');
    const countLargeElement = document.getElementById('sendingRecipientsCountLarge');
    
    if (countElement) countElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
    if (countLargeElement) countLargeElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
    
    return fetch('/api/sending/recipients')
        .then(response => {
            logPerformance('API fetch /api/sending/recipients', start);
            return response.json();
        })
        .then(data => {
            if (countElement) countElement.textContent = data.count;
            if (countLargeElement) countLargeElement.textContent = data.count;
            logPerformance('Total loadSendingRecipients', start);
        })
        .catch(error => {
            console.error('‚ùå Error loading recipients:', error);
            if (countElement) countElement.textContent = '?';
            if (countLargeElement) countLargeElement.textContent = '?';
        });
}

function startSendingCampaign() {
    // Update modal counts
    let activeCount = 0;
    let inactiveCount = 0;
    
    Object.values(monitoredFroms).forEach(account => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'active') {
                activeCount++;
            } else {
                inactiveCount++;
            }
        });
    });
    
    document.getElementById('modalActiveCount').textContent = activeCount;
    document.getElementById('modalInactiveCount').textContent = inactiveCount;
    document.getElementById('modalTotalCount').textContent = activeCount + inactiveCount;
    document.getElementById('modalRecipientsCount').textContent = document.getElementById('sendingRecipientsCount').textContent;
    
    // Show modal
    campaignStartModal.show();
}

function confirmStartCampaign(fromSource) {
    campaignStartModal.hide();
    
    // Save from_source to settings first
    fetch('/api/sending/save_settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            from_source: fromSource,
            sender_name: document.getElementById('sendingSenderName').value,
            subject: document.getElementById('sendingSubject').value,
            message: document.getElementById('sendingMessage').value,
            sleep_time: document.getElementById('sendingSleepTime').value,
            threads: document.getElementById('sendingThreads').value
        })
    })
    .then(() => {
        // Start campaign
        return fetch('/api/sending/start', {
            method: 'POST'
        });
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sendingCampaignRunning = true;
            updateSendingButtons();
            addToSendingConsole(`Campaign started with ${fromSource} froms`, 'success');
            // Switch to console tab
            document.getElementById('sending-console-tab').click();
        } else {
            showSendingAlert('danger', data.message || 'Error starting campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Error starting campaign');
    });
}

function stopSendingCampaign() {
    if (!confirm('Stop the sending campaign?')) return;
    
    fetch('/api/sending/stop', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sendingCampaignRunning = false;
            updateSendingButtons();
            addToSendingConsole('Campaign stopped by user', 'warning');
        } else {
            showSendingAlert('danger', 'Error stopping campaign');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Error stopping campaign');
    });
}

function checkSendingStatus() {
    fetch('/api/sending/status')
        .then(response => response.json())
        .then(data => {
            sendingCampaignRunning = data.running;
            updateSendingButtons();
            updateStatusBadge(data.running);
        })
        .catch(error => console.error('Error checking status:', error));
}

function updateSendingButtons() {
    if (sendingCampaignRunning) {
        document.getElementById('startSendingBtn').style.display = 'none';
        document.getElementById('stopSendingBtn').style.display = 'inline-block';
    } else {
        document.getElementById('startSendingBtn').style.display = 'inline-block';
        document.getElementById('stopSendingBtn').style.display = 'none';
    }
}

function updateStatusBadge(running) {
    const badge = document.getElementById('sendingStatusBadge');
    if (running) {
        badge.className = 'badge bg-success fs-6';
        badge.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span><i class="bi bi-play-fill"></i> Running';
    } else {
        badge.className = 'badge bg-secondary fs-6';
        badge.innerHTML = '<i class="bi bi-stop-circle"></i> Stopped';
    }
}

function updateSendingStats(data) {
    if (data.sent !== undefined) {
        document.getElementById('sendingSentCount').textContent = data.sent;
    }
}

function addToSendingConsole(message, type = 'info') {
    const console = document.getElementById('sendingConsole');
    const timestamp = new Date().toLocaleTimeString();
    
    let color = '#d4d4d4';
    let icon = '‚ÑπÔ∏è';
    
    if (type === 'success') {
        color = '#4ec9b0';
        icon = '‚úÖ';
    } else if (type === 'error') {
        color = '#f48771';
        icon = '‚ùå';
    } else if (type === 'warning') {
        color = '#dcdcaa';
        icon = '‚ö†Ô∏è';
    }
    
    const logEntry = `<div style="color: ${color}; margin-bottom: 5px;">[${timestamp}] ${icon} ${message}</div>`;
    console.innerHTML += logEntry;
    console.scrollTop = console.scrollHeight;
}

function clearSendingConsole() {
    document.getElementById('sendingConsole').innerHTML = '<div class="text-muted">Console cleared.</div>';
}

function showSendingAlert(type, message) {
    const alertContainer = document.getElementById('sendingAlertContainer');
    const alert = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    alertContainer.innerHTML = alert;
    setTimeout(() => {
        alertContainer.innerHTML = '';
    }, 5000);
}

function showAlert(containerId, message, type = 'info') {
    const alertContainer = document.getElementById(containerId);
    if (!alertContainer) {
        console.warn(`Alert container ${containerId} not found`);
        return;
    }
    const alert = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    alertContainer.innerHTML = alert;
    setTimeout(() => {
        alertContainer.innerHTML = '';
    }, 5000);
}

function showNotification(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body: body });
    }
}

// Request notification permission
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}

// Checkbox selection functions
function toggleSelectAllActive(checkbox) {
    const checkboxes = document.querySelectorAll('.active-from-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
}

function toggleSelectAllInactive(checkbox) {
    const checkboxes = document.querySelectorAll('.inactive-from-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
}

// Bulk move functions
function moveSelectedToInactive() {
    const checkboxes = document.querySelectorAll('.active-from-checkbox:checked');
    if (checkboxes.length === 0) {
        showSendingAlert('warning', 'No emails selected');
        return;
    }
    
    if (!confirm(`Move ${checkboxes.length} email(s) to inactive?`)) return;
    
    const emails = Array.from(checkboxes).map(cb => cb.value);
    bulkToggleStatus(emails, 'inactive');
}

function moveSelectedToActive() {
    const checkboxes = document.querySelectorAll('.inactive-from-checkbox:checked');
    if (checkboxes.length === 0) {
        showSendingAlert('warning', 'No emails selected');
        return;
    }
    
    if (!confirm(`Move ${checkboxes.length} email(s) to active?`)) return;
    
    const emails = Array.from(checkboxes).map(cb => cb.value);
    bulkToggleStatus(emails, 'active');
}

function moveAllToInactive() {
    let activeEmails = [];
    Object.values(monitoredFroms).forEach(account => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'active') {
                activeEmails.push(fromEmail.email);
            }
        });
    });
    
    if (activeEmails.length === 0) {
        showSendingAlert('warning', 'No active emails to move');
        return;
    }
    
    if (!confirm(`Move all ${activeEmails.length} active email(s) to inactive?`)) return;
    
    bulkToggleStatus(activeEmails, 'inactive');
}

function moveAllToActive() {
    let inactiveEmails = [];
    Object.values(monitoredFroms).forEach(account => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'inactive') {
                inactiveEmails.push(fromEmail.email);
            }
        });
    });
    
    if (inactiveEmails.length === 0) {
        showSendingAlert('warning', 'No inactive emails to move');
        return;
    }
    
    if (!confirm(`Move all ${inactiveEmails.length} inactive email(s) to active?`)) return;
    
    bulkToggleStatus(inactiveEmails, 'active');
}

function bulkToggleStatus(emails, newStatus) {
    fetch('/api/sending/bulk_toggle', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            emails: emails,
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSendingAlert('success', `Moved ${data.count} email(s) to ${newStatus}`);
            loadMonitoredFroms();
            // Uncheck select all
            document.getElementById('selectAllActive').checked = false;
            document.getElementById('selectAllInactive').checked = false;
        } else {
            showSendingAlert('danger', 'Error moving emails');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Error moving emails');
    });
}

// ========================================
// DELETE AND COPY FUNCTIONS
// ========================================

function deleteSelectedActive() {
    const checkboxes = document.querySelectorAll('#activeFromsList input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
        showSendingAlert('warning', 'No emails selected');
        return;
    }
    if (!confirm(`Delete ${checkboxes.length} email(s) permanently?`)) return;
    const emails = Array.from(checkboxes).map(cb => cb.value);
    deleteFromEmails(emails);
}

function deleteSelectedInactive() {
    const checkboxes = document.querySelectorAll('#inactiveFromsList input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
        showSendingAlert('warning', 'No emails selected');
        return;
    }
    if (!confirm(`Delete ${checkboxes.length} email(s) permanently?`)) return;
    const emails = Array.from(checkboxes).map(cb => cb.value);
    deleteFromEmails(emails);
}

function deleteAllActive() {
    let activeEmails = [];
    Object.values(monitoredFroms).forEach(account => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'active') {
                activeEmails.push(fromEmail.email);
            }
        });
    });
    if (activeEmails.length === 0) {
        showSendingAlert('warning', 'No active emails to delete');
        return;
    }
    if (!confirm(`Delete ALL ${activeEmails.length} active email(s) permanently?`)) return;
    deleteAllFromsByStatus('active');
}

function deleteAllInactive() {
    let inactiveEmails = [];
    Object.values(monitoredFroms).forEach(account => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'inactive') {
                inactiveEmails.push(fromEmail.email);
            }
        });
    });
    if (inactiveEmails.length === 0) {
        showSendingAlert('warning', 'No inactive emails to delete');
        return;
    }
    if (!confirm(`Delete ALL ${inactiveEmails.length} inactive email(s) permanently?`)) return;
    deleteAllFromsByStatus('inactive');
}

function deleteFromEmails(emails) {
    fetch('/api/sending/delete_froms', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({emails})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showSendingAlert('success', `Deleted ${data.deleted} email(s)`);
            loadMonitoredFroms();
            document.getElementById('selectAllActive').checked = false;
            document.getElementById('selectAllInactive').checked = false;
        } else {
            showSendingAlert('danger', 'Error deleting emails');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Network error');
    });
}

function deleteAllFromsByStatus(status) {
    fetch('/api/sending/delete_all_froms', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showSendingAlert('success', `Deleted ${data.deleted} ${status} email(s)`);
            loadMonitoredFroms();
        } else {
            showSendingAlert('danger', 'Error deleting emails');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showSendingAlert('danger', 'Network error');
    });
}

function copyAllActive() {
    let activeEmails = [];
    Object.values(monitoredFroms).forEach(account => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'active') {
                activeEmails.push(fromEmail.email);
            }
        });
    });
    if (activeEmails.length === 0) {
        showSendingAlert('warning', 'No active emails to copy');
        return;
    }
    copyToClipboard(activeEmails.join('\n'));
    showSendingAlert('success', `Copied ${activeEmails.length} active emails to clipboard`);
}

function copyAllInactive() {
    let inactiveEmails = [];
    Object.values(monitoredFroms).forEach(account => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'inactive') {
                inactiveEmails.push(fromEmail.email);
            }
        });
    });
    if (inactiveEmails.length === 0) {
        showSendingAlert('warning', 'No inactive emails to copy');
        return;
    }
    copyToClipboard(inactiveEmails.join('\n'));
    showSendingAlert('success', `Copied ${inactiveEmails.length} inactive emails to clipboard`);
}

function copyToClipboard(text) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(text);
    } else {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
    }
}

// ========================================
// RECHECK FROMS FUNCTIONS
// ========================================

let recheckProgressModal;
let recheckResultsModal;
let recheckCountdownInterval;
let recheckResults = { working: [], failed: [], pending: [] };
let recheckWorkingEmails = new Set(); // Track working emails

// Load recheck configuration from backend
function loadRecheckConfig() {
    fetch('/api/recheck/get_config')
        .then(res => res.json())
        .then(data => {
            if (data.success && data.config) {
                const config = data.config;
                
                // Populate form fields
                if (config.from_source) {
                    document.getElementById('recheckFromSource').value = config.from_source;
                }
                if (config.threads) {
                    document.getElementById('recheckThreads').value = config.threads;
                }
                if (config.sender_name) {
                    document.getElementById('recheckSenderName').value = config.sender_name;
                }
                if (config.subject) {
                    document.getElementById('recheckSubject').value = config.subject;
                }
                if (config.recipients && config.recipients.length > 0) {
                    document.getElementById('recheckRecipients').value = config.recipients.join('\n');
                }
                if (config.message) {
                    document.getElementById('recheckMessage').value = config.message;
                }
                
                console.log('‚úÖ Loaded recheck config:', config.threads, 'threads');
            }
        })
        .catch(err => {
            console.error('Error loading recheck config:', err);
        });
}

// Save recheck configuration
function saveRecheckConfig() {
    const threads = parseInt(document.getElementById('recheckThreads').value) || 3;
    const config = {
        from_source: document.getElementById('recheckFromSource').value,
        threads: Math.min(Math.max(threads, 1), 10), // Ensure 1-10 range
        sender_name: document.getElementById('recheckSenderName').value,
        subject: document.getElementById('recheckSubject').value,
        recipients: document.getElementById('recheckRecipients').value.split('\n').filter(r => r.trim()),
        message: document.getElementById('recheckMessage').value
    };
    
    fetch('/api/recheck/save_config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showAlert('recheckAlertContainer', `Configuration saved successfully! (${data.threads_saved} threads)`, 'success');
        } else {
            showAlert('recheckAlertContainer', data.message || 'Failed to save configuration', 'danger');
        }
    })
    .catch(err => {
        showAlert('recheckAlertContainer', 'Error saving configuration', 'danger');
    });
}

// Show from source selection modal
function showRecheckFromSourceModal() {
    // Update counts
    let activeCount = 0;
    let inactiveCount = 0;
    
    Object.values(monitoredFroms).forEach(account => {
        account.from_emails.forEach(fromEmail => {
            if (fromEmail.status === 'active') {
                activeCount++;
            } else {
                inactiveCount++;
            }
        });
    });
    
    document.getElementById('recheckModalActiveCount').textContent = activeCount;
    document.getElementById('recheckModalInactiveCount').textContent = inactiveCount;
    document.getElementById('recheckModalAllCount').textContent = activeCount + inactiveCount;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('recheckFromSourceModal'));
    modal.show();
}

// Confirm and start recheck with selected source
function confirmStartRecheck(fromSource) {
    // Close the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('recheckFromSourceModal'));
    if (modal) {
        modal.hide();
    }
    
    // Update the from_source dropdown
    document.getElementById('recheckFromSource').value = fromSource;
    
    // Start the campaign
    startRecheckCampaign();
}

// Start recheck campaign
function startRecheckCampaign() {
    // This is now called by confirmStartRecheck() with the from_source parameter
    // Save config first
    const threads = parseInt(document.getElementById('recheckThreads').value) || 3;
    const fromSource = document.getElementById('recheckFromSource').value; // Get from dropdown
    const config = {
        from_source: fromSource,
        threads: Math.min(Math.max(threads, 1), 10), // Ensure 1-10 range
        sender_name: document.getElementById('recheckSenderName').value,
        subject: document.getElementById('recheckSubject').value,
        recipients: document.getElementById('recheckRecipients').value.split('\n').filter(r => r.trim()),
        message: document.getElementById('recheckMessage').value
    };
    
    // Validate
    if (config.recipients.length === 0) {
        showAlert('recheckAlertContainer', 'Please add test recipients', 'warning');
        return;
    }
    
    // Save and start
    fetch('/api/recheck/save_config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Now start campaign
            return fetch('/api/recheck/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
        } else {
            throw new Error(data.message || 'Failed to save config');
        }
    })
    .then(res => {
        if (!res.ok) {
            // Handle HTTP errors
            return res.json().then(errData => {
                throw new Error(errData.message || `HTTP ${res.status}: ${res.statusText}`);
            });
        }
        return res.json();
    })
    .then(data => {
        if (data.success) {
            // Show progress modal
            recheckProgressModal = new bootstrap.Modal(document.getElementById('recheckProgressModal'));
            recheckProgressModal.show();
            
            // Reset UI
            document.getElementById('recheckSendingProgress').style.width = '0%';
            document.getElementById('recheckSendingText').textContent = '0/0 (0%)';
            document.getElementById('recheckWorkingCount').textContent = '0';
            document.getElementById('recheckPendingCount').textContent = '0';
            document.getElementById('recheckFailedCount').textContent = '0';
            document.getElementById('recheckBatchCountdown').textContent = '0'; // Confirmed working count
            document.getElementById('recheckActivityLog').innerHTML = '<div class="text-muted">Starting campaign...</div>';
            document.getElementById('recheckWorkingLog').value = ''; // Clear working log
            recheckWorkingEmails.clear(); // Clear working set
            
            document.getElementById('recheckPhase2').style.display = 'none';
            document.getElementById('recheckPendingCount').textContent = '0';
            document.getElementById('recheckFailedCount').textContent = '0';
            document.getElementById('recheckActivityLog').innerHTML = '<div class="text-muted">Starting campaign...</div>';
            document.getElementById('stopRecheckBtn').style.display = 'inline-block';
            document.getElementById('viewResultsBtn').style.display = 'none';
            document.getElementById('closeRecheckModal').style.display = 'none';
            
            recheckResults = { working: [], failed: [], pending: [] };
        } else {
            showAlert('recheckAlertContainer', data.message || 'Failed to start campaign', 'danger');
        }
    })
    .catch(err => {
        console.error('Recheck error:', err);
        showAlert('recheckAlertContainer', err.message || 'Error starting campaign', 'danger');
    });
}

// Copy all working emails from the working log
function copyWorkingEmails() {
    const workingLog = document.getElementById('recheckWorkingLog');
    const emails = workingLog.value.trim();
    
    if (!emails) {
        alert('No working emails to copy yet');
        return;
    }
    
    // Copy to clipboard
    navigator.clipboard.writeText(emails).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-info');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-info');
            btn.classList.add('btn-success');
        }, 2000);
        
        console.log(`üìã Copied ${emails.split('\n').filter(e => e.trim()).length} working emails to clipboard`);
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy to clipboard. Please select and copy manually.');
    });
}

// Copy real-time working emails from results modal
function copyRealTimeWorking() {
    const emails = document.getElementById('realTimeWorkingEmails').value.trim();
    
    if (!emails) {
        alert('No working emails to copy');
        return;
    }
    
    navigator.clipboard.writeText(emails).then(() => {
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
        btn.classList.remove('btn-light');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-light');
        }, 2000);
        
        const count = emails.split('\n').filter(e => e.trim()).length;
        console.log(`üìã Copied ${count} real-time working emails to clipboard`);
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy to clipboard');
    });
}

// Stop recheck campaign
function stopRecheckCampaign() {
    if (!confirm('Stop the recheck campaign?')) return;
    
    fetch('/api/recheck/stop', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            addRecheckActivity('‚õî Campaign stopped by user', 'warning');
            if (recheckCountdownInterval) {
                clearInterval(recheckCountdownInterval);
            }
            document.getElementById('stopRecheckBtn').style.display = 'none';
            document.getElementById('viewResultsBtn').style.display = 'inline-block';
            document.getElementById('closeRecheckModal').style.display = 'inline-block';
            
            // Allow fresh restart
            document.getElementById('startRecheckBtn').disabled = false;
            
            // Prompt to swap results
            promptSwapResults();
        }
    });
}

// Start 5-minute countdown
function startRecheckCountdown() {
    let timeLeft = 300; // 5 minutes in seconds
    
    document.getElementById('recheckPhase1').style.display = 'none';
    document.getElementById('recheckPhase2').style.display = 'block';
    
    recheckCountdownInterval = setInterval(() => {
        timeLeft--;
        
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById('recheckCountdown').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            clearInterval(recheckCountdownInterval);
            document.getElementById('recheckCountdown').textContent = '0:00';
            addRecheckActivity('‚è±Ô∏è Time limit reached - Campaign complete', 'info');
            document.getElementById('stopRecheckBtn').style.display = 'none';
            document.getElementById('viewResultsBtn').style.display = 'inline-block';
            document.getElementById('closeRecheckModal').style.display = 'inline-block';
            
            // Prompt to swap results after countdown
            promptSwapResults();
        }
    }, 1000);
}

// Add activity to log
function addRecheckActivity(message, type = 'info') {
    const log = document.getElementById('recheckActivityLog');
    const now = new Date();
    const timestamp = now.toLocaleTimeString();
    
    const icons = {
        'info': '‚ÑπÔ∏è',
        'success': '‚úÖ',
        'warning': '‚ö†Ô∏è',
        'error': '‚ùå'
    };
    
    const entry = document.createElement('div');
    entry.className = `text-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'secondary'}`;
    entry.textContent = `[${timestamp}] ${icons[type]} ${message}`;
    
    log.insertBefore(entry, log.firstChild);
    
    // Keep only last 50 entries
    while (log.children.length > 50) {
        log.removeChild(log.lastChild);
    }
}

// View full results
function viewRecheckResults() {
    // Get real-time working emails from the working log
    const workingLog = document.getElementById('recheckWorkingLog');
    const realTimeEmails = workingLog ? workingLog.value.trim() : '';
    
    // Load results first
    fetch('/api/recheck/results')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                recheckResults = data.results;
                
                // Render results in tables
                renderRecheckResults();
                
                // Show real-time working emails if available
                if (realTimeEmails) {
                    const emailList = realTimeEmails.split('\n').filter(e => e.trim());
                    document.getElementById('realTimeWorkingSection').style.display = 'block';
                    document.getElementById('realTimeWorkingEmails').value = realTimeEmails;
                    document.getElementById('realTimeWorkingCount').textContent = emailList.length;
                } else {
                    document.getElementById('realTimeWorkingSection').style.display = 'none';
                }
                
                // Hide progress modal if open
                if (recheckProgressModal) {
                    recheckProgressModal.hide();
                }
                
                // Show results modal
                if (!recheckResultsModal) {
                    recheckResultsModal = new bootstrap.Modal(document.getElementById('recheckResultsModal'));
                }
                recheckResultsModal.show();
            } else {
                alert('Failed to load results: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(err => {
            console.error('Error loading results:', err);
            alert('Network error while loading results');
        });
}

// Prompt to swap results (move old active to inactive, new working to active)
function promptSwapResults() {
    fetch('/api/recheck/results')
        .then(res => res.json())
        .then(data => {
            if (data.success && data.results.working.length > 0) {
                const working = data.results.working.length;
                const msg = `‚úÖ Found ${working} working from emails!\n\n` +
                           `Do you want to:\n` +
                           `‚Ä¢ Move all OLD active emails ‚Üí Inactive\n` +
                           `‚Ä¢ Move all NEW working emails ‚Üí Active\n\n` +
                           `This will replace your active froms with freshly verified ones.`;
                
                if (confirm(msg)) {
                    swapRecheckResults();
                } else {
                    showAlert('recheckAlertContainer', 'You can manually manage results using "View Results" button', 'info');
                }
            }
        });
}

// Execute swap (old active ‚Üí inactive, new working ‚Üí active)
function swapRecheckResults() {
    fetch('/api/recheck/swap_results', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showAlert('recheckAlertContainer', 
                `‚úÖ Swapped successfully!\n` +
                `‚Ä¢ ${data.moved_to_inactive} old emails ‚Üí Inactive\n` +
                `‚Ä¢ ${data.moved_to_active} working emails ‚Üí Active`, 
                'success');
            loadMonitoredFroms(); // Refresh the from lists
            
            // Close results modal if open
            if (recheckResultsModal) {
                recheckResultsModal.hide();
            }
        } else {
            showAlert('recheckAlertContainer', data.message || 'Error swapping results', 'danger');
        }
    })
    .catch(err => {
        console.error('Swap error:', err);
        showAlert('recheckAlertContainer', 'Network error while swapping results', 'danger');
    });
}

// Replace Active Froms - single button action
function replaceActiveFroms() {
    const working = recheckResults.working || [];
    
    if (working.length === 0) {
        alert('No working from addresses found to replace with');
        return;
    }
    
    const msg = `üîÑ Replace Active Froms\n\n` +
               `This will:\n` +
               `‚Ä¢ Move ALL old active emails ‚Üí Inactive\n` +
               `‚Ä¢ Move ${working.length} new working emails ‚Üí Active\n\n` +
               `Your active froms will be replaced with freshly verified ones.\n\n` +
               `Continue?`;
    
    if (!confirm(msg)) {
        return;
    }
    
    // Call the swap API
    swapRecheckResults();
}

// Render results tables
function renderRecheckResults() {
    const working = recheckResults.working || [];
    const failed = recheckResults.failed || [];
    
    // Update counts
    document.getElementById('workingTabCount').textContent = working.length;
    document.getElementById('failedTabCount').textContent = failed.length;
    
    const total = working.length + failed.length;
    document.getElementById('resultsSummaryText').textContent = 
        `Tested ${total} from addresses: ${working.length} working, ${failed.length} failed`;
    
    // Working table
    const workingTable = document.getElementById('workingResultsTable');
    if (working.length === 0) {
        workingTable.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No working froms detected</td></tr>';
    } else {
        workingTable.innerHTML = working.map(from => {
            const responseTime = from.delivered_at && from.sent_at ? 
                Math.round((new Date(from.delivered_at) - new Date(from.sent_at)) / 1000) : 'N/A';
            return `
                <tr>
                    <td><input type="checkbox" class="working-checkbox" value="${from.email}"></td>
                    <td>${from.email}</td>
                    <td>${new Date(from.sent_at).toLocaleString()}</td>
                    <td>${from.delivered_at ? new Date(from.delivered_at).toLocaleString() : 'N/A'}</td>
                    <td>${responseTime !== 'N/A' ? responseTime + 's' : 'N/A'}</td>
                </tr>
            `;
        }).join('');
    }
    
    // Failed table
    const failedTable = document.getElementById('failedResultsTable');
    if (failed.length === 0) {
        failedTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No failed froms</td></tr>';
    } else {
        failedTable.innerHTML = failed.map(from => `
            <tr>
                <td><input type="checkbox" class="failed-checkbox" value="${from.email}"></td>
                <td>${from.email}</td>
                <td>${new Date(from.sent_at).toLocaleString()}</td>
                <td><span class="badge bg-danger">No Response</span></td>
            </tr>
        `).join('');
    }
}

// Toggle select all working
function toggleSelectAllWorking() {
    const checked = document.getElementById('selectAllWorking').checked;
    document.querySelectorAll('.working-checkbox').forEach(cb => cb.checked = checked);
}

// Toggle select all failed
function toggleSelectAllFailed() {
    const checked = document.getElementById('selectAllFailed').checked;
    document.querySelectorAll('.failed-checkbox').forEach(cb => cb.checked = checked);
}

// Move working to active
function moveWorkingToActive() {
    const working = recheckResults.working || [];
    const emails = working.map(f => f.email);
    
    if (emails.length === 0) {
        alert('No working from addresses to move');
        return;
    }
    
    if (!confirm(`Move ${emails.length} working from addresses to Active?`)) {
        return;
    }
    
    applyBulkStatusChange(emails, 'active');
}

// Move failed to inactive
function moveFailedToInactive() {
    const failed = recheckResults.failed || [];
    const emails = failed.map(f => f.email);
    
    if (emails.length === 0) {
        alert('No failed from addresses to move');
        return;
    }
    
    if (!confirm(`Move ${emails.length} failed from addresses to Inactive?`)) {
        return;
    }
    
    applyBulkStatusChange(emails, 'inactive');
}

// Swap active and inactive
function swapActiveInactive() {
    const working = recheckResults.working || [];
    const failed = recheckResults.failed || [];
    
    if (working.length === 0 && failed.length === 0) {
        alert('No results to process');
        return;
    }
    
    if (!confirm(`Move ${working.length} working to Active and ${failed.length} failed to Inactive?`)) {
        return;
    }
    
    fetch('/api/recheck/apply_results', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'swap' })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(`Updated statuses: ${data.active_count} moved to Active, ${data.inactive_count} moved to Inactive`);
            loadMonitoredFroms(); // Refresh the from lists
            if (recheckResultsModal) {
                recheckResultsModal.hide();
            }
        } else {
            alert(data.message || 'Failed to update statuses');
        }
    })
    .catch(err => {
        alert('Error updating statuses');
    });
}

// Apply bulk status change
function applyBulkStatusChange(emails, status) {
    fetch('/api/recheck/apply_results', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            action: 'bulk',
            emails: emails,
            status: status
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(`Updated ${data.count} from addresses to ${status}`);
            loadMonitoredFroms(); // Refresh the from lists
            if (recheckResultsModal) {
                recheckResultsModal.hide();
            }
        } else {
            alert(data.message || 'Failed to update statuses');
        }
    })
    .catch(err => {
        alert('Error updating statuses');
    });
}

// Socket.IO listeners for recheck events
if (typeof socket !== 'undefined') {
    socket.on('recheck_progress', function(data) {
        // Update progress bar only (Phase 1: Sending)
        const percent = (data.sent / data.total * 100).toFixed(0);
        document.getElementById('recheckSendingProgress').style.width = percent + '%';
        document.getElementById('recheckSendingText').textContent = `${data.sent}/${data.total} (${percent}%)`;
        
        // Note: Pending count is updated by recheck_response_detected (Phase 2: Responses)
        // Don't update here as it would overwrite actual response counts
    });
    
    socket.on('recheck_log', function(data) {
        addRecheckActivity(data.message, data.log_type || 'info');
    });
    
    socket.on('recheck_sending_complete', function(data) {
        addRecheckActivity('‚úÖ All test emails sent! Starting 5-minute countdown...', 'success');
        startRecheckCountdown();
    });
    
    socket.on('recheck_response_detected', function(data) {
        // Update stats
        document.getElementById('recheckWorkingCount').textContent = data.working_count;
        document.getElementById('recheckPendingCount').textContent = data.pending_count;
        document.getElementById('recheckFailedCount').textContent = data.failed_count;
        
        // Update confirmed working counter (top right)
        document.getElementById('recheckBatchCountdown').textContent = data.working_count;
        
        // Add to activity
        addRecheckActivity(`‚úÖ Response detected from: ${data.from_email}`, 'success');
        
        // Add to working log (prevent duplicates)
        if (!recheckWorkingEmails.has(data.from_email)) {
            recheckWorkingEmails.add(data.from_email);
            const workingLog = document.getElementById('recheckWorkingLog');
            workingLog.value += data.from_email + '\n';
            workingLog.scrollTop = workingLog.scrollHeight; // Auto-scroll to bottom
        }
    });
}

</script>
{% endblock %}
