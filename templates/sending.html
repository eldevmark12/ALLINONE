{% extends "base.html" %}

{% block title %}Sending - ALL-in-One Email Portal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h1><i class="bi bi-send-fill"></i> Monitored From Emails</h1>
        <p class="text-muted">Real-time email monitoring from external accounts</p>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-server"></i> Accounts</h5>
                <h2 class="mb-0" id="monitoredAccounts">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-envelope-fill"></i> Total Emails</h5>
                <h2 class="mb-0" id="monitoredTotalEmails">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-person-check"></i> Unique Froms</h5>
                <h2 class="mb-0" id="monitoredUniqueFroms">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-clock-history"></i> Last Update</h5>
                <h6 class="mb-0" id="monitoredLastUpdate">Never</h6>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">From Emails by Account</h5>
                    <button class="btn btn-primary" onclick="refreshMonitoredData()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th>From Emails</th>
                                <th>Total Emails</th>
                                <th>Last Email</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="monitoredFromsList">
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <i class="bi bi-inbox"></i> No data received yet. Waiting for initial scan...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load monitored data from email monitoring API
function loadMonitoredData() {
    fetch('/api/monitored/froms')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Update statistics
                document.getElementById('monitoredAccounts').textContent = data.total_accounts || 0;
                document.getElementById('monitoredTotalEmails').textContent = (data.total_emails || 0).toLocaleString();
                document.getElementById('monitoredUniqueFroms').textContent = (data.unique_froms || 0).toLocaleString();
                
                if (data.last_update) {
                    const lastUpdate = new Date(data.last_update);
                    document.getElementById('monitoredLastUpdate').textContent = lastUpdate.toLocaleString();
                } else {
                    document.getElementById('monitoredLastUpdate').textContent = 'Never';
                }
                
                // Update table
                const tbody = document.getElementById('monitoredFromsList');
                if (data.accounts && data.accounts.length > 0) {
                    tbody.innerHTML = '';
                    data.accounts.forEach(account => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${account.account_name}</strong></td>
                            <td><span class="badge bg-primary">${account.from_count || 0}</span></td>
                            <td><span class="badge bg-info">${account.email_count || 0}</span></td>
                            <td><small class="text-muted">${account.last_email || 'N/A'}</small></td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewAccountFroms('${account.account_name}')">
                                    <i class="bi bi-eye"></i> View
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                <i class="bi bi-inbox"></i> No data received yet. Waiting for initial scan...
                            </td>
                        </tr>
                    `;
                }
            }
        })
        .catch(err => {
            console.error('Error loading monitored data:', err);
        });
}

function refreshMonitoredData() {
    loadMonitoredData();
    showAlert('Data refreshed!', 'success');
}

function viewAccountFroms(accountName) {
    // TODO: Show modal with all from emails for this account
    alert('View from emails for: ' + accountName);
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.row').insertAdjacentElement('afterbegin', alertDiv);
    setTimeout(() => alertDiv.remove(), 3000);
}

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMonitoredData();
    
    // Poll for monitored data every 30 seconds
    setInterval(loadMonitoredData, 30000);
});
</script>
{% endblock %}
